<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="theme-color" content="#18120a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Minas 11">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal CondÃ³minos Â· Real de Minas 11</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,300&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "e6b778b4-c510-4ded-886e-1b3821b6a14a",
      safari_web_id: "web.onesignal.auto.e6b778b4-c510-4ded-886e-1b3821b6a14a",
      notifyButton: { enable: false },
      allowLocalhostAsSecureOrigin: true,
    });
  });
</script>
<style>
:root{
  --ink:#18120a;--cream:#f8f4ed;--warm:#efe7d5;--gold:#c49a22;--gold2:#e8b84b;
  --rust:#8b3a0f;--sage:#3a5c3c;--sage2:#4d7a50;--red:#8b1a1a;--amber:#7a5200;
  --slate:#2c3e50;--bdr:rgba(24,18,10,.10);--sh:0 2px 24px rgba(24,18,10,.07);
  --nav-h:64px;--top-h:52px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--ink);
  min-height:100vh;overscroll-behavior:none;}

/* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-screen{
  min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(ellipse 70% 50% at 15% 85%,rgba(196,154,34,.1) 0%,transparent 55%),
    radial-gradient(ellipse 50% 70% at 85% 15%,rgba(58,92,60,.09) 0%,transparent 55%),var(--cream);
  padding:2rem;
}
.lcard{background:#fff;border:1px solid var(--bdr);border-radius:3px;padding:3rem 2.5rem;
  width:100%;max-width:380px;box-shadow:0 12px 60px rgba(24,18,10,.13);position:relative;overflow:hidden;}
.lcard::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;
  background:linear-gradient(90deg,var(--gold),var(--rust),var(--sage));}
.llogo{text-align:center;margin-bottom:2rem;}
.llogo .icon{font-size:2.5rem;margin-bottom:.7rem;}
.llogo h1{font-family:'Fraunces',serif;font-size:1.7rem;font-weight:500;letter-spacing:-.02em;color:var(--ink);}
.llogo p{font-size:.7rem;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--gold);margin-top:.3rem;}
.ldiv{width:2rem;height:1px;background:var(--gold);margin:.8rem auto 0;}
.fgrp{margin-bottom:1.2rem;}
.fgrp label{display:block;font-size:.65rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  color:rgba(24,18,10,.45);margin-bottom:.45rem;}
.fgrp input{width:100%;padding:.72rem .9rem;border:1.5px solid var(--bdr);border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.95rem;background:var(--cream);
  color:var(--ink);outline:none;transition:border-color .15s;}
.fgrp input:focus{border-color:var(--gold);}
.lbtn{width:100%;padding:.85rem;background:var(--ink);color:var(--cream);border:none;
  border-radius:3px;font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:700;
  letter-spacing:.12em;text-transform:uppercase;cursor:pointer;margin-top:.5rem;transition:background .2s;}
.lbtn:hover{background:#2d2419;}
.lbtn:disabled{opacity:.6;cursor:not-allowed;}
.loading-bar{height:2px;background:linear-gradient(90deg,var(--gold),var(--sage));
  margin-top:.5rem;display:none;animation:lb 1.2s ease-in-out infinite;}
@keyframes lb{0%{transform:scaleX(0);transform-origin:left}50%{transform:scaleX(1);transform-origin:left}51%{transform:scaleX(1);transform-origin:right}100%{transform:scaleX(0);transform-origin:right}}
.lerr{background:#fef2f2;border:1px solid rgba(139,26,26,.2);color:var(--red);
  border-radius:3px;padding:.7rem .9rem;font-size:.8rem;text-align:center;
  margin-top:.8rem;display:none;}
.lhint{text-align:center;font-size:.72rem;color:rgba(24,18,10,.38);margin-top:1rem;}

/* â”€â”€ GOODBYE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#goodbye-screen{display:none;position:fixed;inset:0;background:var(--cream);
  flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;z-index:300;}
.goodbye-btn{padding:.7rem 1.5rem;background:var(--ink);color:var(--cream);border:none;
  border-radius:3px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:700;
  letter-spacing:.08em;text-transform:uppercase;cursor:pointer;margin-top:1rem;}

/* â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:none;flex-direction:column;min-height:100vh;}

/* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{position:fixed;top:0;left:0;right:0;height:var(--top-h);z-index:100;
  background:var(--ink);display:flex;align-items:center;justify-content:space-between;
  padding:0 1rem;box-shadow:0 2px 12px rgba(0,0,0,.25);}
.tb-brand{display:flex;align-items:center;gap:.6rem;}
.tb-brand span{font-family:'Fraunces',serif;font-size:1rem;color:var(--cream);letter-spacing:-.01em;}
.tb-dept{font-size:.65rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  background:var(--gold);color:var(--ink);padding:.2rem .5rem;border-radius:2px;}
.lo-btn{background:none;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.7);
  padding:.3rem .7rem;border-radius:2px;font-family:'DM Sans',sans-serif;font-size:.7rem;
  font-weight:600;cursor:pointer;letter-spacing:.06em;text-transform:uppercase;transition:all .15s;}
.lo-btn:hover{border-color:rgba(255,255,255,.5);color:#fff;}

/* â”€â”€ BOTTOM NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);
  background:#fff;border-top:1px solid var(--bdr);
  display:flex;z-index:100;box-shadow:0 -4px 20px rgba(24,18,10,.08);}
.bnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:.2rem;background:none;border:none;cursor:pointer;padding:.5rem .2rem;
  transition:all .15s;position:relative;}
.bnav-btn .bnav-icon{font-size:1.3rem;line-height:1;transition:transform .2s;}
.bnav-btn .bnav-label{font-family:'DM Sans',sans-serif;font-size:.58rem;font-weight:600;
  letter-spacing:.06em;text-transform:uppercase;color:rgba(24,18,10,.38);transition:color .15s;}
.bnav-btn.active .bnav-icon{transform:scale(1.15);}
.bnav-btn.active .bnav-label{color:var(--gold);}
.bnav-btn.active::after{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:2rem;height:2px;background:var(--gold);border-radius:0 0 2px 2px;}
.bnav-badge{position:absolute;top:.3rem;right:calc(50% - 1.2rem);background:var(--red);
  color:#fff;font-size:.5rem;font-weight:700;min-width:.9rem;height:.9rem;border-radius:.5rem;
  display:flex;align-items:center;justify-content:center;padding:0 .2rem;}

/* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page{display:none;flex-direction:column;padding-top:var(--top-h);padding-bottom:var(--nav-h);
  min-height:100vh;}
.page.active{display:flex;}
.content{padding:1.5rem 1rem;flex:1;}
.fade-in{animation:fi .3s ease-out;}
@keyframes fi{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:none;}}

/* â”€â”€ SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sync-info{display:flex;align-items:center;gap:.5rem;font-size:.68rem;color:rgba(24,18,10,.35);
  margin-bottom:1.2rem;}
.sync-dot{width:5px;height:5px;border-radius:50%;background:var(--sage);}

/* â”€â”€ SECTION TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stitle{display:flex;align-items:baseline;gap:.7rem;margin:1.5rem 0 .8rem;}
.stitle:first-child{margin-top:0;}
.stitle h2{font-family:'Fraunces',serif;font-size:1.05rem;font-weight:500;}
.tag{font-size:.6rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;
  color:rgba(24,18,10,.35);}

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-row{display:grid;gap:.75rem;margin-bottom:1rem;}
.cols4{grid-template-columns:repeat(2,1fr);}
.cols3{grid-template-columns:repeat(2,1fr);}
.cols2{grid-template-columns:1fr 1fr;}
.kcard{background:#fff;border:1px solid var(--bdr);border-radius:3px;padding:1rem 1.1rem;
  box-shadow:var(--sh);position:relative;overflow:hidden;}
.kcard::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;}
.kcard.g::after{background:var(--sage);}
.kcard.r::after{background:var(--red);}
.kcard.o::after{background:var(--gold);}
.kcard.b::after{background:var(--slate);}
.klbl{font-size:.6rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;
  color:rgba(24,18,10,.4);margin-bottom:.35rem;}
.kval{font-family:'Fraunces',serif;font-size:1.25rem;font-weight:500;line-height:1.1;color:var(--ink);}
.ksub{font-size:.68rem;color:rgba(24,18,10,.4);margin-top:.3rem;}

/* â”€â”€ PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel{background:#fff;border:1px solid var(--bdr);border-radius:3px;
  overflow:hidden;box-shadow:var(--sh);margin-bottom:1rem;}
.panel-pad{padding:1.1rem;}

/* â”€â”€ AVISOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.aviso-card{background:#fff;border:1px solid var(--bdr);border-radius:4px;
  padding:1.2rem;box-shadow:var(--sh);margin-bottom:.85rem;position:relative;overflow:hidden;}
.aviso-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.aviso-card.urgente::before{background:var(--red);}
.aviso-card.info::before{background:var(--gold);}
.aviso-card.general::before{background:var(--sage);}
.aviso-tipo{font-size:.55rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  padding:.2rem .5rem;border-radius:2px;display:inline-block;margin-bottom:.6rem;}
.aviso-tipo.urgente{background:#fef2f2;color:var(--red);}
.aviso-tipo.info{background:#fff8e7;color:var(--amber);}
.aviso-tipo.general{background:#f0faf2;color:var(--sage);}
.aviso-titulo{font-family:'Fraunces',serif;font-size:1rem;font-weight:500;
  color:var(--ink);margin-bottom:.5rem;line-height:1.3;}
.aviso-msg{font-size:.82rem;color:rgba(24,18,10,.65);line-height:1.55;margin-bottom:.7rem;}
.aviso-meta{font-size:.65rem;color:rgba(24,18,10,.35);display:flex;align-items:center;gap:.5rem;}
.aviso-empty{text-align:center;padding:3rem 1rem;color:rgba(24,18,10,.35);}
.aviso-empty .aviso-empty-icon{font-size:2.5rem;margin-bottom:.7rem;}

/* â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
canvas{max-height:220px;}

/* â”€â”€ MES SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mes-selector{display:flex;gap:.4rem;overflow-x:auto;padding:.2rem 0 .7rem;
  scrollbar-width:none;margin-bottom:.5rem;}
.mes-selector::-webkit-scrollbar{display:none;}
.mes-btn{padding:.4rem .7rem;border:1.5px solid var(--bdr);border-radius:2px;background:#fff;
  font-family:'DM Sans',sans-serif;font-size:.7rem;font-weight:600;letter-spacing:.05em;
  text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:all .15s;color:rgba(24,18,10,.5);}
.mes-btn.active{background:var(--ink);color:var(--cream);border-color:var(--ink);}

/* â”€â”€ COBRANZA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cob-row{display:flex;flex-direction:column;gap:.5rem;}
.cob-pct{font-family:'Fraunces',serif;font-size:2rem;color:var(--ink);}
.cob-track{height:6px;background:var(--bdr);border-radius:3px;overflow:hidden;}
.cob-fill{height:100%;background:linear-gradient(90deg,var(--sage),var(--sage2));
  border-radius:3px;transition:width .5s ease;}

/* â”€â”€ EBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ebar-list{display:flex;flex-direction:column;gap:.55rem;}
.ebar-row{display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center;}
.ebar-label{font-size:.72rem;color:rgba(24,18,10,.6);grid-column:1/-1;margin-bottom:.1rem;}
.ebar-track{height:4px;background:var(--bdr);border-radius:2px;overflow:hidden;
  grid-column:1;align-self:center;}
.ebar-fill{height:100%;background:var(--red);border-radius:2px;}
.ebar-val{font-size:.72rem;font-family:'Fraunces',serif;color:var(--red);
  grid-column:2;white-space:nowrap;}

/* â”€â”€ SEMÃFORO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sem-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;}
.sem-cell{background:var(--cream);border-radius:3px;padding:.6rem .4rem;text-align:center;
  border:1px solid var(--bdr);}
.sem-cell.puntual{background:#f0faf2;border-color:rgba(58,92,60,.2);}
.sem-cell.tardio{background:#fff8e7;border-color:rgba(196,154,34,.25);}
.sem-cell.parcial{background:#fff3e0;border-color:rgba(122,82,0,.2);}
.sem-cell.sin_pago{background:#fef2f2;border-color:rgba(139,26,26,.15);}
.sem-mn{font-size:.55rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;
  color:rgba(24,18,10,.45);margin-bottom:.2rem;}
.sem-ic{font-size:.9rem;margin-bottom:.15rem;}
.sem-am{font-family:'Fraunces',serif;font-size:.72rem;color:var(--ink);}
.sem-dy{font-size:.55rem;color:rgba(24,18,10,.4);margin-top:.1rem;}

/* â”€â”€ MORA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mora{background:#fef2f2;border:1px solid rgba(139,26,26,.2);border-radius:3px;
  padding:1rem 1.1rem;display:flex;gap:.8rem;align-items:flex-start;margin-bottom:1rem;}
.mora-ic{font-size:1.2rem;flex-shrink:0;}
.mora h3{font-size:.85rem;font-weight:600;color:var(--red);margin-bottom:.2rem;}
.mora p{font-size:.75rem;color:rgba(24,18,10,.55);line-height:1.4;}

/* â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
table{width:100%;border-collapse:collapse;font-size:.78rem;}
thead th{padding:.65rem .8rem;text-align:left;font-size:.58rem;font-weight:700;
  letter-spacing:.09em;text-transform:uppercase;color:rgba(24,18,10,.4);
  background:var(--cream);border-bottom:1px solid var(--bdr);}
tbody tr{border-bottom:1px solid rgba(24,18,10,.04);}
tbody td{padding:.6rem .8rem;vertical-align:middle;}
.td-f{color:rgba(24,18,10,.55);white-space:nowrap;font-size:.73rem;}
.td-c{font-size:.78rem;}
.td-s{color:rgba(24,18,10,.4);font-size:.72rem;}
.td-m{font-family:'Fraunces',serif;font-size:.85rem;text-align:right;}
.td-m.ing{color:var(--sage);}
.badge{display:inline-block;padding:.15rem .45rem;border-radius:2px;font-size:.58rem;
  font-weight:700;letter-spacing:.07em;text-transform:uppercase;}
.badge.puntual{background:#f0faf2;color:var(--sage);}
.badge.tardio{background:#fff8e7;color:var(--amber);}
.badge.parcial{background:#fff3e0;color:#7a5200;}
.badge.sin_pago{background:#fef2f2;color:var(--red);}

/* â”€â”€ HIST FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hist-filter-row{display:flex;flex-wrap:wrap;gap:.6rem;align-items:flex-end;margin-bottom:.8rem;}
.hist-filter-group{display:flex;flex-direction:column;gap:.3rem;}
.hist-filter-label{font-size:.6rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;
  color:rgba(24,18,10,.4);}
.hist-select,.hist-input{padding:.45rem .65rem;border:1.5px solid var(--bdr);border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.78rem;background:#fff;outline:none;
  color:var(--ink);min-width:110px;}
.hist-select:focus,.hist-input:focus{border-color:var(--gold);}
.hist-clear-btn{padding:.45rem .8rem;background:none;border:1.5px solid var(--bdr);border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.72rem;cursor:pointer;color:rgba(24,18,10,.5);
  align-self:flex-end;transition:all .15s;}
.hist-clear-btn:hover{border-color:var(--red);color:var(--red);}
.hist-summary-row{font-size:.75rem;color:rgba(24,18,10,.45);}

/* â”€â”€ FIN STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fin-stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.7rem;}
.fin-stat-card{background:var(--cream);border-radius:3px;padding:.8rem;text-align:center;}
.fin-stat-icon{font-size:1.3rem;margin-bottom:.3rem;}
.fin-stat-val{font-family:'Fraunces',serif;font-size:1.4rem;color:var(--ink);}
.fin-stat-label{font-size:.6rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;
  color:rgba(24,18,10,.4);margin-top:.2rem;}

/* â”€â”€ SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spin-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:3rem;gap:1rem;color:rgba(24,18,10,.35);font-size:.82rem;}
.spinner{width:28px;height:28px;border:2.5px solid var(--bdr);border-top-color:var(--gold);
  border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ DESKTOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(min-width:768px){
  #app{flex-direction:row;flex-wrap:wrap;}
  .topbar{left:0;right:0;}
  .bottom-nav{
    position:fixed;left:0;top:var(--top-h);bottom:0;width:200px;
    flex-direction:column;border-top:none;border-right:1px solid var(--bdr);
    height:auto;box-shadow:2px 0 12px rgba(24,18,10,.06);
  }
  .bnav-btn{flex-direction:row;justify-content:flex-start;padding:.9rem 1.2rem;gap:.7rem;border-radius:0;}
  .bnav-btn .bnav-icon{font-size:1.1rem;}
  .bnav-btn .bnav-label{font-size:.75rem;letter-spacing:.04em;}
  .bnav-btn.active::after{top:0;left:0;bottom:0;right:auto;width:3px;height:auto;border-radius:0 2px 2px 0;}
  .page{padding-left:200px;padding-bottom:0;min-height:100vh;}
  .content{padding:2rem 2.5rem;max-width:900px;}
  .cols4{grid-template-columns:repeat(4,1fr);}
  .cols3{grid-template-columns:repeat(3,1fr);}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="lcard">
    <div class="llogo">
      <div class="icon">ğŸ¢</div>
      <h1>Real de Minas 11</h1>
      <p>Portal de CondÃ³minos</p>
      <div class="ldiv"></div>
    </div>
    <div class="fgrp">
      <label>Departamento</label>
      <input id="i-dept" type="text" placeholder="Ej: 201, PH1, 305â€¦" autocomplete="off"/>
    </div>
    <div class="fgrp">
      <label>ContraseÃ±a</label>
      <div style="position:relative;display:flex;align-items:center;">
        <input id="i-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="padding-right:2.5rem;width:100%;"/>
        <button type="button" onclick="togglePass('i-pass','eye-portal')" style="position:absolute;right:.6rem;background:none;border:none;cursor:pointer;font-size:1.1rem;color:rgba(24,18,10,.4);padding:0;line-height:1;" id="eye-portal">ğŸ‘</button>
      </div>
    </div>
    <button class="lbtn" id="login-btn" onclick="doLogin()">Ingresar al Portal</button>
    <div class="loading-bar" id="login-loading"></div>
    <div class="lerr" id="lerr"></div>
    <p class="lhint">Â¿Olvidaste tu contraseÃ±a? Contacta a la administraciÃ³n.</p>
  </div>
</div>

<!-- GOODBYE -->
<div id="goodbye-screen">
  <div style="font-size:3rem">ğŸ”’</div>
  <div style="font-family:'Fraunces',serif;font-size:1.4rem;color:var(--ink)">SesiÃ³n cerrada</div>
  <div style="font-size:.85rem;color:rgba(24,18,10,.5);">Puedes cerrar esta ventana</div>
  <button class="goodbye-btn" onclick="document.getElementById('goodbye-screen').style.display='none';document.getElementById('login-screen').style.display='flex';">
    Volver al inicio
  </button>
</div>

<!-- APP -->
<div id="app">

  <!-- TOPBAR -->
  <nav class="topbar">
    <div class="tb-brand">
      <span>Real de Minas 11</span>
    </div>
    <div style="display:flex;align-items:center;gap:.7rem;">
      <span class="tb-dept" id="tb-user"></span>
      <button class="lo-btn" onclick="doLogout()">Salir</button>
    </div>
  </nav>

  <!-- PAGES -->

  <!-- INICIO -->
  <div id="page-inicio" class="page active">
    <div class="content fade-in">
      <div class="sync-info"><div class="sync-dot" id="sync-inicio"></div><span id="sync-label-inicio">Cargandoâ€¦</span></div>
      <div id="inicio-content"><div class="spin-wrap"><div class="spinner"></div><p>Cargando datosâ€¦</p></div></div>
    </div>
  </div>

  <!-- AVISOS -->
  <div id="page-avisos" class="page">
    <div class="content fade-in">
      <div class="sync-info"><div class="sync-dot" id="sync-avisos"></div><span id="sync-label-avisos">Cargandoâ€¦</span></div>
      <div id="avisos-content"><div class="spin-wrap"><div class="spinner"></div><p>Cargando avisosâ€¦</p></div></div>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div id="page-historial" class="page">
    <div class="content fade-in">
      <div class="sync-info"><div class="sync-dot" id="sync-hist"></div><span id="sync-label-hist">Cargandoâ€¦</span></div>
      <div id="historial-content"><div class="spin-wrap"><div class="spinner"></div><p>Cargando historialâ€¦</p></div></div>
    </div>
  </div>

  <!-- EGRESOS -->
  <div id="page-egresos" class="page">
    <div class="content fade-in">
      <div class="sync-info"><div class="sync-dot" id="sync-egr"></div><span id="sync-label-egr">Cargandoâ€¦</span></div>
      <div id="egresos-content"><div class="spin-wrap"><div class="spinner"></div><p>Cargando egresosâ€¦</p></div></div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="bnav-btn active" id="bnav-inicio" onclick="navTo('inicio')">
      <span class="bnav-icon">ğŸ </span>
      <span class="bnav-label">Inicio</span>
    </button>
    <button class="bnav-btn" id="bnav-avisos" onclick="navTo('avisos')">
      <span class="bnav-icon">ğŸ“¢</span>
      <span class="bnav-label">Avisos</span>
      <span class="bnav-badge" id="badge-avisos" style="display:none"></span>
    </button>
    <button class="bnav-btn" id="bnav-historial" onclick="navTo('historial')">
      <span class="bnav-icon">ğŸ’³</span>
      <span class="bnav-label">Mis Pagos</span>
    </button>
    <button class="bnav-btn" id="bnav-egresos" onclick="navTo('egresos')">
      <span class="bnav-icon">ğŸ“Š</span>
      <span class="bnav-label">Egresos</span>
    </button>
  </nav>

</div><!-- /app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEET_ID   = '1BmKygJycO6wTF409i0stnVg3GX26apWGgQ-byPbRlnA';
const SHEET_BASE = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

const HOJAS_MESES = [
  'Enero 2025','Febrero 2025','Marzo 2025','Abril 2025',
  'Mayo 2025','Junio 2025','Julio 2025','Agosto 2025',
  'Septiembre 2025','Octubre 2025','Noviembre 2025','Diciembre 2025',
  'Enero 2026'
];

let PASSWORDS = {};
const CAT_LABELS = {"SM-VIG":"Vigilancia","SM-LIM":"Limpieza","SM-ADM":"AdministraciÃ³n","SM-BAS":"Basura","SM-JAT":"JardinerÃ­a","SM-INT":"Internet","SB-CFE":"CFE / Luz","SB-ELV":"Elevadores","SB-PLT":"Planta luz","PE-CAB":"Cable elevador","PE-INT":"Interfon","PE-CIS":"Cisterna","MR-BOM":"Bombas","MR-ELE":"Electricista","MR-VID":"Lavado vidrios","MR-GEN":"Mantenimiento general","MR-PLOM":"PlomerÃ­a","CI-INS":"Compras e insumos","ME-BAN":"InversiÃ³n/Bancos","ME-DEV":"Devoluciones","ME-CAJ":"Caja chica","ME-PEN":"PenalizaciÃ³n","OTROS":"Otros"};
const MES_SHORT = {'Enero 2025':'Ene 25','Febrero 2025':'Feb 25','Marzo 2025':'Mar 25','Abril 2025':'Abr 25','Mayo 2025':'May 25','Junio 2025':'Jun 25','Julio 2025':'Jul 25','Agosto 2025':'Ago 25','Septiembre 2025':'Sep 25','Octubre 2025':'Oct 25','Noviembre 2025':'Nov 25','Diciembre 2025':'Dic 25','Enero 2026':'Ene 26'};
const ST_ICON  = {puntual:'âœ“',tardio:'âœ“',parcial:'~',sin_pago:'Â·'};
const ST_LABEL = {puntual:'Puntual',tardio:'TardÃ­o',parcial:'Parcial',sin_pago:'Sin pago'};
const TOTAL_DEPTOS = 28;

let currentDept = null;
let DATA = null;
let _histPagos = [];
let charts = {};
let currentPage = 'inicio';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt    = n => !n&&n!==0?'â€”':new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
const fmtDec = n => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2}).format(n);

function navTo(page) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('bnav-'+page).classList.add('active');
  currentPage = page;
  // Trigger render if needed
  const renderers = {inicio:renderInicio,avisos:renderAvisos,historial:renderHistorial,egresos:renderEgresos};
  if(DATA && renderers[page]) renderers[page]();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePass(inputId,btnId){
  const inp=document.getElementById(inputId),btn=document.getElementById(btnId);
  if(inp.type==='password'){inp.type='text';btn.textContent='ğŸ™ˆ';}
  else{inp.type='password';btn.textContent='ğŸ‘';}
}

async function doLogin(){
  const dept=document.getElementById('i-dept').value.trim().toUpperCase();
  const pass=document.getElementById('i-pass').value.trim();
  const err=document.getElementById('lerr'),btn=document.getElementById('login-btn'),bar=document.getElementById('login-loading');
  err.style.display='none';btn.disabled=true;btn.textContent='Verificandoâ€¦';bar.style.display='block';
  try{
    const table=await fetchSheet('ContraseÃ±as');
    const pwdRows=table.rows.map(r=>r.c.map(c=>c?c.v:null));
    PASSWORDS={};pwdRows.forEach(row=>{if(row[0]&&row[1])PASSWORDS[String(row[0])]=String(row[1]);});
  }catch(e){console.warn('Could not load passwords:',e);}
  if(PASSWORDS[dept]&&PASSWORDS[dept]===pass){
    currentDept=dept;
    try{
      const exp=new Date(Date.now()+10*365*24*60*60*1000).toUTCString();
      document.cookie=`minas11_dept=${dept};expires=${exp};path=/`;
      document.cookie=`minas11_pass=${encodeURIComponent(pass)};expires=${exp};path=/`;
      localStorage.setItem('minas11_dept',dept);localStorage.setItem('minas11_pass',pass);
    }catch(e){}
    btn.textContent='Cargando datosâ€¦';
    loadAllData().then(()=>{
      document.getElementById('login-screen').style.display='none';
      document.getElementById('app').style.display='flex';
      document.getElementById('tb-user').textContent=dept;
      renderAll();
      // Request push permission after login
      try{
        OneSignalDeferred.push(async function(OneSignal){
          await OneSignal.Notifications.requestPermission();
        });
      }catch(e){}
    }).catch(e=>{
      btn.disabled=false;btn.textContent='Ingresar al Portal';bar.style.display='none';
      err.textContent='Error al conectar. Verifica tu conexiÃ³n.';err.style.display='block';
    });
  }else{
    btn.disabled=false;btn.textContent='Ingresar al Portal';bar.style.display='none';
    err.textContent='Departamento o contraseÃ±a incorrectos';err.style.display='block';
    document.getElementById('i-pass').value='';
  }
}

document.addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

function getCookie(name){const m=document.cookie.match('(?:^|; )'+name+'=([^;]*)');return m?decodeURIComponent(m[1]):null;}

(async function autoLogin(){
  try{
    let dept=getCookie('minas11_dept')||localStorage.getItem('minas11_dept');
    let pass=getCookie('minas11_pass')||localStorage.getItem('minas11_pass');
    if(!dept||!pass)return;
    document.getElementById('i-dept').value=dept;
    document.getElementById('i-pass').value=pass;
    await doLogin();
  }catch(e){}
})();

function doLogout(){
  try{
    document.cookie='minas11_dept=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/';
    document.cookie='minas11_pass=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/';
    localStorage.removeItem('minas11_dept');localStorage.removeItem('minas11_pass');
  }catch(e){}
  currentDept=null;DATA=null;
  Object.values(charts).forEach(c=>{if(c)c.destroy();});charts={};
  document.getElementById('app').style.display='none';
  document.getElementById('login-screen').style.display='none';
  document.getElementById('goodbye-screen').style.display='flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchSheet(name){
  const res=await fetch(SHEET_BASE+encodeURIComponent(name));
  const txt=await res.text();
  const json=JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?\s*$/)[1]);
  return json.table;
}
function tableToRows(table){
  if(!table||!table.rows)return[];
  return table.rows.map(r=>r.c.map(c=>c?c.v:null));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAllData(){
  const results=await Promise.all(HOJAS_MESES.map(m=>fetchSheet(m).catch(()=>null)));
  const monthlyData={},deptPagos={};

  HOJAS_MESES.forEach((mes,idx)=>{
    const table=results[idx];if(!table)return;
    const rows=tableToRows(table);
    let saldoAnterior=0,totalIngresos=0,totalEgresos=0,egresosCat={};
    const deptsPagaron=new Set();
    rows.forEach(row=>{
      if(!row[0])return;
      if(row[0]==='SALDO MES ANTERIOR'){saldoAnterior=typeof row[4]==='number'?row[4]:0;return;}
      if(row[0]==='FECHA'||row[0]==='TOTAL'||String(row[0]).includes('ESTADO DE CUENTA'))return;
      const fecha=row[0],nombre=row[2]||'',ingreso=typeof row[3]==='number'?row[3]:0,egreso=typeof row[4]==='number'?row[4]:0,idConc=row[6]||'',idEgr=row[7]||'';
      if(ingreso>0){
        totalIngresos+=ingreso;
        const m=idConc.match(/^CM-(.+)$/);
        if(m){
          const dept=m[1];deptsPagaron.add(dept);
          if(!deptPagos[dept])deptPagos[dept]=[];
          deptPagos[dept].push({fecha:typeof fecha==='string'?fecha:String(fecha),concepto:nombre,monto:ingreso,mes});
        }
      }
      if(egreso>0){totalEgresos+=egreso;const cat=(idEgr||'OTROS').split('-').slice(0,2).join('-')||'OTROS';egresosCat[cat]=(egresosCat[cat]||0)+egreso;}
    });
    monthlyData[mes]={mes,saldo_anterior:saldoAnterior,total_ingresos:totalIngresos,total_egresos:totalEgresos,egresos_por_cat:egresosCat,deptos_pagaron:deptsPagaron.size,total_deptos:TOTAL_DEPTOS,pct_cobranza:deptsPagaron.size/TOTAL_DEPTOS};
  });

  const deptMontosMes={};
  Object.entries(deptPagos).forEach(([dept,pagos])=>{
    pagos.forEach(p=>{if(!deptMontosMes[dept])deptMontosMes[dept]={};deptMontosMes[dept][p.mes]=(deptMontosMes[dept][p.mes]||0)+p.monto;});
  });

  const deptCuota={};
  Object.keys(PASSWORDS).forEach(dept=>{
    const montos=Object.values(deptMontosMes[dept]||{}).filter(v=>v>0);
    if(!montos.length){deptCuota[dept]=0;return;}
    montos.sort((a,b)=>a-b);deptCuota[dept]=montos[Math.floor(montos.length/2)];
  });

  const deptData={};
  Object.keys(PASSWORDS).forEach(dept=>{
    const cuota=deptCuota[dept]||0,pagos=deptPagos[dept]||[];
    const resumen=HOJAS_MESES.map(mes=>{
      const monto=(deptMontosMes[dept]&&deptMontosMes[dept][mes])||0;
      const pm=pagos.filter(p=>p.mes===mes);
      const diaStr=pm.length>0?(pm[0].fecha||'').split('/')[0]:'';
      const dia=diaStr?parseInt(diaStr):null;
      let status='sin_pago';
      if(monto>0)status=monto>=cuota*0.98?(dia&&dia<=10?'puntual':'tardio'):'parcial';
      return{mes,total:monto,dia,status};
    });
    deptData[dept]={cuota,morosidad:0,pagos,resumen_mensual:resumen};
  });

  const monthly=HOJAS_MESES.map(mes=>monthlyData[mes]||{mes,saldo_anterior:0,total_ingresos:0,total_egresos:0,egresos_por_cat:{},deptos_pagaron:0,total_deptos:TOTAL_DEPTOS,pct_cobranza:0});
  DATA={monthly,deptData};

  const now=new Date(),t=now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
  ['inicio','avisos','hist','egr'].forEach(k=>{
    const d=document.getElementById('sync-'+k),l=document.getElementById('sync-label-'+k);
    if(d)d.classList.remove('stale');if(l)l.textContent=`Actualizado ${t}`;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){renderInicio();renderAvisos();renderHistorial();renderEgresos();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INICIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInicio(){
  const d=DATA.deptData[currentDept];
  if(!d){document.getElementById('inicio-content').innerHTML='<p style="padding:1rem;color:var(--red)">No se encontraron datos para este departamento.</p>';return;}
  const resumen=d.resumen_mensual;
  const totalPag=d.pagos.reduce((s,p)=>s+p.monto,0);
  const espTotal=d.cuota*resumen.length;
  const pct=espTotal>0?(totalPag/espTotal*100).toFixed(1):0;
  const nPunt=resumen.filter(m=>m.status==='puntual').length;
  const nSin=resumen.filter(m=>m.status==='sin_pago').length;
  const MONTHLY=DATA.monthly;
  const lastSaldo=MONTHLY[MONTHLY.length-1].saldo_anterior;
  const avgCob=MONTHLY.reduce((s,m)=>s+m.pct_cobranza,0)/MONTHLY.length;

  let html='';
  if(d.morosidad>0)html+=`<div class="mora"><div class="mora-ic">âš ï¸</div><div><h3>Saldo pendiente: ${fmtDec(d.morosidad)}</h3><p>Contacta a la administraciÃ³n.</p></div></div>`;

  html+=`
    <div class="stitle"><h2>Mi Cuenta</h2><span class="tag">Depto ${currentDept}</span></div>
    <div class="kpi-row cols2">
      <div class="kcard g"><div class="klbl">Total pagado</div><div class="kval">${fmt(totalPag)}</div><div class="ksub">${d.pagos.length} pagos</div></div>
      <div class="kcard o"><div class="klbl">Cuota mensual</div><div class="kval">${fmt(d.cuota)}</div><div class="ksub">${nPunt} meses a tiempo</div></div>
    </div>
    <div class="kpi-row cols2">
      <div class="kcard ${pct>=90?'g':pct>=60?'o':'r'}"><div class="klbl">Cumplimiento</div><div class="kval">${pct}%</div><div class="ksub">${nSin} sin pago</div></div>
      <div class="kcard b"><div class="klbl">Saldo bancario</div><div class="kval">${fmt(lastSaldo)}</div><div class="ksub">Ãšltimo mes</div></div>
    </div>
    <div class="stitle"><h2>Estado por mes</h2></div>
    <div class="panel panel-pad"><div class="sem-grid">${resumen.map(m=>`
      <div class="sem-cell ${m.status}">
        <div class="sem-mn">${MES_SHORT[m.mes]||m.mes}</div>
        <div class="sem-ic">${ST_ICON[m.status]}</div>
        <div class="sem-am">${m.total>0?fmt(m.total):'â€”'}</div>
        <div class="sem-dy">${m.dia?'DÃ­a '+m.dia:ST_LABEL[m.status]}</div>
      </div>`).join('')}</div></div>
    <div class="stitle"><h2>Condominio</h2><span class="tag">${MONTHLY.length} meses</span></div>
    <div class="kpi-row cols2">
      <div class="kcard g"><div class="klbl">Ingresos totales</div><div class="kval">${fmt(MONTHLY.reduce((s,m)=>s+m.total_ingresos,0))}</div><div class="ksub">${MONTHLY.length} meses</div></div>
      <div class="kcard r"><div class="klbl">Egresos totales</div><div class="kval">${fmt(MONTHLY.reduce((s,m)=>s+m.total_egresos,0))}</div><div class="ksub">Todos los conceptos</div></div>
    </div>
    <div class="kcard b" style="margin-bottom:1rem"><div class="klbl">Cobranza promedio</div><div class="kval">${(avgCob*100).toFixed(1)}%</div><div class="ksub">${TOTAL_DEPTOS} departamentos</div></div>
  `;
  document.getElementById('inicio-content').innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AVISOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderAvisos(){
  document.getElementById('avisos-content').innerHTML='<div class="spin-wrap"><div class="spinner"></div><p>Cargando avisosâ€¦</p></div>';
  try{
    const table=await fetchSheet('Avisos');
    const rows=tableToRows(table);
    // Cols: A=Fecha, B=Tipo(urgente/info/general), C=Titulo, D=Mensaje
    const avisos=rows.filter(r=>r[2]).reverse(); // newest first
    const badge=document.getElementById('badge-avisos');
    if(avisos.length>0){badge.textContent=avisos.length;badge.style.display='flex';}
    else{badge.style.display='none';}
    if(!avisos.length){
      document.getElementById('avisos-content').innerHTML=`<div class="aviso-empty"><div class="aviso-empty-icon">ğŸ“­</div><p>No hay avisos por el momento.</p></div>`;
      return;
    }
    document.getElementById('avisos-content').innerHTML=`
      <div class="stitle"><h2>Avisos y Comunicados</h2><span class="tag">${avisos.length} publicados</span></div>
      ${avisos.map(r=>{
        const tipo=(r[1]||'general').toLowerCase();
        const fecha=r[0]?String(r[0]).split('T')[0]:'';
        return`<div class="aviso-card ${tipo}">
          <span class="aviso-tipo ${tipo}">${tipo==='urgente'?'ğŸš¨ Urgente':tipo==='info'?'â„¹ï¸ InformaciÃ³n':'ğŸ“Œ General'}</span>
          <div class="aviso-titulo">${r[2]||''}</div>
          <div class="aviso-msg">${(r[3]||'').replace(/\n/g,'<br>')}</div>
          <div class="aviso-meta">ğŸ“… ${fecha}</div>
        </div>`;
      }).join('')}
    `;
  }catch(e){
    document.getElementById('avisos-content').innerHTML=`<div class="aviso-empty"><div class="aviso-empty-icon">ğŸ“­</div><p>No hay avisos disponibles.</p></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistorial(){
  const d=DATA.deptData[currentDept];if(!d)return;
  const resumen=d.resumen_mensual;
  _histPagos=[...d.pagos].sort((a,b)=>b.fecha.split('/').reverse().join('').localeCompare(a.fecha.split('/').reverse().join(''))).map(p=>{
    const ms=resumen.find(m=>m.mes===p.mes);return{...p,status:ms?ms.status:'parcial'};
  });
  const meses=[...new Set(d.pagos.map(p=>p.mes))];
  document.getElementById('historial-content').innerHTML=`
    <div class="stitle"><h2>Historial de Pagos</h2><span class="tag">Depto ${currentDept}</span></div>
    <div class="panel panel-pad" style="margin-bottom:1rem;">
      <div class="hist-filter-row">
        <div class="hist-filter-group">
          <label class="hist-filter-label">Mes</label>
          <select id="hist-filter-mes" class="hist-select" onchange="applyHistFilters()">
            <option value="">Todos</option>${meses.map(m=>`<option value="${m}">${m}</option>`).join('')}
          </select>
        </div>
        <div class="hist-filter-group">
          <label class="hist-filter-label">Estado</label>
          <select id="hist-filter-status" class="hist-select" onchange="applyHistFilters()">
            <option value="">Todos</option>
            <option value="puntual">Puntual</option>
            <option value="tardio">TardÃ­o</option>
            <option value="parcial">Parcial</option>
            <option value="sin_pago">Sin pago</option>
          </select>
        </div>
      </div>
      <div class="hist-summary-row" id="hist-summary"></div>
    </div>
    <div class="panel"><table>
      <thead><tr><th>Fecha</th><th>Concepto</th><th style="text-align:right">Monto</th><th>Estado</th></tr></thead>
      <tbody id="hist-tbody"></tbody>
    </table>
    <div id="hist-empty" style="display:none;text-align:center;padding:2rem;color:rgba(24,18,10,.35);font-size:.82rem;">Sin resultados.</div>
    </div>
  `;
  applyHistFilters();
}

function applyHistFilters(){
  const mesFil=document.getElementById('hist-filter-mes')?.value||'';
  const statFil=document.getElementById('hist-filter-status')?.value||'';
  const filtered=_histPagos.filter(p=>{
    if(mesFil&&p.mes!==mesFil)return false;
    if(statFil&&p.status!==statFil)return false;
    return true;
  });
  const tbody=document.getElementById('hist-tbody'),empty=document.getElementById('hist-empty');
  if(!tbody)return;
  if(!filtered.length){tbody.innerHTML='';empty.style.display='block';}
  else{
    empty.style.display='none';
    tbody.innerHTML=filtered.map(p=>`<tr>
      <td class="td-f">${p.fecha}</td>
      <td class="td-c">${p.concepto}</td>
      <td class="td-m ing">${fmtDec(p.monto)}</td>
      <td><span class="badge ${p.status}">${ST_LABEL[p.status]}</span></td>
    </tr>`).join('');
  }
  const total=filtered.reduce((s,p)=>s+p.monto,0);
  const sumEl=document.getElementById('hist-summary');
  if(sumEl)sumEl.innerHTML=`${filtered.length} pagos Â· Total: <strong>${fmtDec(total)}</strong>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EGRESOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEgresos(){
  const MONTHLY=DATA.monthly;
  const totalEgr=MONTHLY.reduce((s,m)=>s+m.total_egresos,0);
  const allCats={};
  MONTHLY.forEach(m=>Object.entries(m.egresos_por_cat).forEach(([cat,val])=>{allCats[cat]=(allCats[cat]||0)+val;}));
  const cats=Object.entries(allCats).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]);
  const maxCat=cats.length?cats[0][1]:1;

  let html=`
    <div class="stitle"><h2>Egresos del Condominio</h2><span class="tag">${MONTHLY.length} meses</span></div>
    <div class="kpi-row cols2">
      <div class="kcard r"><div class="klbl">Total egresos</div><div class="kval">${fmt(totalEgr)}</div><div class="ksub">${MONTHLY.length} meses</div></div>
      <div class="kcard o"><div class="klbl">Promedio mensual</div><div class="kval">${fmt(totalEgr/MONTHLY.length)}</div><div class="ksub">Por mes</div></div>
    </div>
    <div class="stitle"><h2>Por categorÃ­a</h2></div>
    <div class="panel panel-pad">
      <div class="ebar-list">${cats.map(([cat,val])=>`
        <div>
          <div class="ebar-label">${CAT_LABELS[cat]||cat}</div>
          <div class="ebar-row">
            <div class="ebar-track" style="flex:1"><div class="ebar-fill" style="width:${(val/maxCat*100).toFixed(1)}%"></div></div>
            <div class="ebar-val">${fmt(val)}</div>
          </div>
        </div>`).join('')}
      </div>
    </div>
    <div class="stitle"><h2>Por mes</h2></div>
    <div class="mes-selector" id="egr-mes-sel"></div>
    <div class="panel panel-pad" id="egr-mes-detail"></div>
  `;

  document.getElementById('egresos-content').innerHTML=html;

  // Mes selector
  const sel=document.getElementById('egr-mes-sel');
  MONTHLY.forEach((m,i)=>{
    const btn=document.createElement('button');
    btn.className='mes-btn'+(i===MONTHLY.length-1?' active':'');
    btn.textContent=MES_SHORT[m.mes]||m.mes;
    btn.onclick=()=>{document.querySelectorAll('.mes-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderEgresosMes(i);};
    sel.appendChild(btn);
  });
  renderEgresosMes(MONTHLY.length-1);
}

function renderEgresosMes(idx){
  const m=DATA.monthly[idx];
  const cats=Object.entries(m.egresos_por_cat).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]);
  const maxE=cats.length?cats[0][1]:1;
  document.getElementById('egr-mes-detail').innerHTML=`
    <div style="margin-bottom:.8rem;display:flex;justify-content:space-between;align-items:baseline;">
      <span style="font-family:'Fraunces',serif;font-size:1rem;">${m.mes}</span>
      <span style="font-family:'Fraunces',serif;font-size:1.1rem;color:var(--red);">${fmt(m.total_egresos)}</span>
    </div>
    <div class="ebar-list">${cats.map(([cat,val])=>`
      <div>
        <div class="ebar-label">${CAT_LABELS[cat]||cat}</div>
        <div class="ebar-row">
          <div class="ebar-track" style="flex:1"><div class="ebar-fill" style="width:${(val/maxE*100).toFixed(1)}%"></div></div>
          <div class="ebar-val">${fmt(val)}</div>
        </div>
      </div>`).join('')}
    </div>
  `;
}
</script>
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').catch(()=>{});});
}
</script>
</body>
</html>
