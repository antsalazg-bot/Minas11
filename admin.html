<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="theme-color" content="#18120a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Minas 11">
<link rel="manifest" href="manifest-admin.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ¬∑ Real de Minas 11</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--ink:#18120a;--cream:#f8f4ed;--warm:#efe7d5;--gold:#c49a22;--gold2:#e8b84b;--rust:#8b3a0f;--sage:#3a5c3c;--red:#8b1a1a;--amber:#7a5200;--slate:#2c3e50;--blue:#1a3a5c;--bdr:rgba(24,18,10,.10);--sh:0 2px 24px rgba(24,18,10,.07);}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:#f0ece4;color:var(--ink);min-height:100vh;}

/* MOBILE */
@media(max-width:768px){
  .sidebar{position:fixed;left:-240px;top:56px;bottom:0;z-index:150;transition:left .25s ease;box-shadow:none;}
  .sidebar.open{left:0;box-shadow:4px 0 20px rgba(24,18,10,.15);}
  .sidebar-overlay{display:none;position:fixed;inset:0;top:56px;background:rgba(24,18,10,.35);z-index:140;}
  .sidebar-overlay.open{display:block;}
  .main-content{width:100%;}
  .hamburger{display:flex!important;}
  .kpi-row.c4{grid-template-columns:1fr 1fr!important;}
  .kpi-row.c3{grid-template-columns:1fr 1fr!important;}
  .kpi-row.c2{grid-template-columns:1fr!important;}
  .kval{font-size:1.4rem!important;}
  .content{padding:1.5rem 1rem!important;}
  .page-hdr h1{font-size:1.3rem!important;}
  .dept-grid{grid-template-columns:repeat(4,1fr)!important;}
  .sem-grid{grid-template-columns:repeat(3,1fr)!important;}
  .form-grid{grid-template-columns:1fr!important;}
  .form-group.full{grid-column:1!important;}
  .stitle h2{font-size:1rem!important;}
  .panel canvas{max-height:200px!important;}
  .tb-sync{display:none;}
  table{font-size:.75rem!important;}
  thead th{padding:.5rem .6rem!important;font-size:.55rem!important;}
  tbody td{padding:.5rem .6rem!important;}
  .em-stats{display:none!important;}
}
.hamburger{display:none;align-items:center;justify-content:center;
  background:none;border:none;color:var(--cream);font-size:1.3rem;
  cursor:pointer;padding:.2rem .4rem;margin-right:.3rem;line-height:1;}

/* LOGIN */
#login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(ellipse 60% 60% at 20% 80%,rgba(139,58,15,.12) 0%,transparent 55%),
  radial-gradient(ellipse 50% 60% at 80% 20%,rgba(28,58,92,.1) 0%,transparent 55%),#f0ece4;padding:2rem;}
.lcard{background:#fff;border:1px solid var(--bdr);border-radius:4px;padding:3rem 3.5rem;
  width:100%;max-width:420px;box-shadow:0 16px 60px rgba(24,18,10,.15);position:relative;overflow:hidden;}
.lcard::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;
  background:linear-gradient(90deg,var(--blue),var(--rust),var(--gold));}
.llogo{text-align:center;margin-bottom:2.5rem;}
.llogo .badge-admin{display:inline-block;background:var(--ink);color:var(--gold);
  font-size:.65rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;
  padding:.3rem .8rem;border-radius:2px;margin-bottom:1rem;}
.llogo h1{font-family:'Fraunces',serif;font-size:1.6rem;font-weight:500;letter-spacing:-.02em;}
.llogo p{font-size:.72rem;color:rgba(24,18,10,.4);letter-spacing:.1em;text-transform:uppercase;margin-top:.4rem;}
.fgrp{margin-bottom:1.1rem;}
.fgrp label{display:block;font-size:.68rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(24,18,10,.4);margin-bottom:.45rem;}
.fgrp input{width:100%;padding:.75rem 1rem;border:1.5px solid var(--bdr);border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.92rem;background:var(--cream);color:var(--ink);outline:none;transition:border-color .2s;}
.fgrp input:focus{border-color:var(--gold);}
.lbtn{width:100%;padding:.85rem;background:var(--ink);color:var(--cream);border:none;border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:700;letter-spacing:.1em;
  text-transform:uppercase;cursor:pointer;transition:background .2s;margin-top:.4rem;}
.lbtn:hover{background:var(--blue);}
.lbtn:disabled{background:rgba(24,18,10,.3);cursor:not-allowed;}
.lerr{background:#fef2f2;border:1px solid rgba(139,26,26,.2);color:var(--red);padding:.65rem 1rem;
  border-radius:3px;font-size:.82rem;margin-top:.9rem;display:none;text-align:center;}
.lbar{width:100%;height:3px;background:var(--warm);border-radius:2px;margin-top:1rem;display:none;overflow:hidden;}
.lbar::after{content:'';display:block;height:100%;width:40%;background:var(--gold);
  border-radius:2px;animation:slide 1s infinite linear;}
@keyframes slide{0%{transform:translateX(-100%)}100%{transform:translateX(350%)}}

/* TOPBAR */
#app{display:none;min-height:100vh;flex-direction:column;}
.topbar{background:var(--ink);height:56px;padding:0 2rem;display:flex;align-items:center;
  justify-content:space-between;position:sticky;top:0;z-index:200;}
.tb-left{display:flex;align-items:center;gap:1rem;}
.tb-badge{background:var(--gold);color:var(--ink);font-size:.6rem;font-weight:800;
  letter-spacing:.12em;text-transform:uppercase;padding:.25rem .6rem;border-radius:2px;}
.tb-title{font-family:'Fraunces',serif;font-size:1rem;color:var(--cream);}
.tb-right{display:flex;align-items:center;gap:1.2rem;}
.tb-sync{font-size:.68rem;color:rgba(248,244,237,.35);}
.lo-btn{background:none;border:1px solid rgba(248,244,237,.18);color:rgba(248,244,237,.55);
  padding:.32rem .85rem;border-radius:3px;font-size:.72rem;font-family:'DM Sans',sans-serif;
  cursor:pointer;letter-spacing:.05em;transition:all .2s;}
.lo-btn:hover{background:rgba(248,244,237,.1);color:var(--cream);}

/* LAYOUT */
.app-body{display:flex;flex:1;min-height:calc(100vh - 56px);}
.sidebar{width:220px;background:#fff;border-right:1px solid var(--bdr);flex-shrink:0;
  display:flex;flex-direction:column;padding:1.5rem 0;}
.sb-section{padding:0 1rem;margin-bottom:.3rem;}
.sb-lbl{font-size:.6rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;
  color:rgba(24,18,10,.28);padding:.5rem .6rem;margin-bottom:.2rem;}
.slink{display:flex;align-items:center;gap:.7rem;padding:.65rem .85rem;border-radius:3px;
  font-size:.82rem;font-weight:500;color:rgba(24,18,10,.55);cursor:pointer;transition:all .15s;
  border:none;background:none;width:100%;text-align:left;font-family:'DM Sans',sans-serif;}
.slink:hover{background:var(--warm);color:var(--ink);}
.slink.active{background:var(--ink);color:var(--cream);}
.slink .ic{font-size:1rem;width:20px;text-align:center;}
.main-content{flex:1;overflow-y:auto;}
.content{max-width:1200px;margin:0 auto;padding:2.5rem 2rem;}

/* VIEWS */
.view{display:none;}
.view.active{display:block;}

/* SPINNER */
.spin-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;gap:1rem;}
.spinner{width:32px;height:32px;border:3px solid var(--warm);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.spin-wrap p{font-size:.8rem;color:rgba(24,18,10,.4);}

/* PAGE HEADER */
.page-hdr{margin-bottom:2rem;padding-bottom:1.2rem;border-bottom:1px solid var(--bdr);}
.page-hdr h1{font-family:'Fraunces',serif;font-size:1.6rem;font-weight:500;margin-bottom:.3rem;}
.page-hdr p{font-size:.82rem;color:rgba(24,18,10,.45);}

/* KPI */
.kpi-row{display:grid;gap:1.2rem;margin-bottom:2rem;}
.kpi-row.c2{grid-template-columns:repeat(2,1fr);}
.kpi-row.c3{grid-template-columns:repeat(3,1fr);}
.kpi-row.c4{grid-template-columns:repeat(4,1fr);}
@media(max-width:900px){.kpi-row.c4,.kpi-row.c3{grid-template-columns:1fr 1fr;}}
.kcard{background:#fff;border:1px solid var(--bdr);border-radius:3px;padding:1.4rem 1.6rem;
  box-shadow:var(--sh);position:relative;overflow:hidden;}
.kcard::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;}
.kcard.g::after{background:var(--sage);}
.kcard.o::after{background:var(--gold);}
.kcard.r::after{background:var(--red);}
.kcard.b::after{background:var(--blue);}
.kcard.s::after{background:var(--slate);}
.klbl{font-size:.63rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:rgba(24,18,10,.38);margin-bottom:.55rem;}
.kval{font-family:'Fraunces',serif;font-size:1.9rem;line-height:1;color:var(--ink);}
.ksub{font-size:.74rem;color:rgba(24,18,10,.42);margin-top:.35rem;}

/* STITLE */
.stitle{display:flex;align-items:baseline;gap:.7rem;margin-bottom:1.2rem;margin-top:2rem;}
.stitle h2{font-family:'Fraunces',serif;font-size:1.15rem;font-weight:500;}
.stitle .tag{font-size:.63rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(24,18,10,.3);}

/* PANEL */
.panel{background:#fff;border:1px solid var(--bdr);border-radius:3px;overflow:hidden;box-shadow:var(--sh);margin-bottom:2rem;}
.panel-pad{padding:1.6rem 1.8rem;}
.panel canvas{max-height:260px;}

/* TABLE */
table{width:100%;border-collapse:collapse;font-size:.83rem;}
thead th{padding:.75rem 1rem;text-align:left;font-size:.61rem;font-weight:700;letter-spacing:.1em;
  text-transform:uppercase;color:rgba(24,18,10,.38);background:var(--cream);border-bottom:1px solid var(--bdr);}
tbody tr{border-bottom:1px solid rgba(24,18,10,.04);transition:background .1s;}
tbody tr:hover{background:rgba(24,18,10,.02);}
tbody tr:last-child{border-bottom:none;}
tbody td{padding:.75rem 1rem;}
.td-num{font-family:'Fraunces',serif;font-size:.9rem;text-align:right;}
.td-num.pos{color:var(--sage);}
.td-num.neg{color:var(--red);}
.td-muted{color:rgba(24,18,10,.42);font-size:.78rem;}

/* BADGES */
.badge{display:inline-block;padding:.2rem .6rem;border-radius:2px;font-size:.62rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;}
.badge.puntual{background:#f0faf2;color:var(--sage);}
.badge.tardio{background:#fef8e7;color:var(--amber);}
.badge.parcial{background:#fef8e7;color:var(--amber);}
.badge.sin_pago{background:#fef2f2;color:var(--red);}
.badge.ok{background:#f0faf2;color:var(--sage);}
.badge.warn{background:#fef8e7;color:var(--amber);}
.badge.danger{background:#fef2f2;color:var(--red);}

/* DEPT SELECTOR */
.dept-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:.45rem;margin-bottom:1.5rem;}
@media(max-width:700px){.dept-grid{grid-template-columns:repeat(4,1fr);}}
.dept-btn{padding:.45rem .3rem;border:1.5px solid var(--bdr);border-radius:3px;font-size:.74rem;
  font-weight:600;background:#fff;color:rgba(24,18,10,.55);cursor:pointer;transition:all .15s;
  font-family:'DM Sans',sans-serif;text-align:center;}
.dept-btn:hover{border-color:var(--gold);color:var(--ink);}
.dept-btn.active{background:var(--ink);color:var(--cream);border-color:var(--ink);}
.dept-btn.mora{border-color:rgba(139,26,26,.3);color:var(--red);}
.dept-btn.mora.active{background:var(--red);border-color:var(--red);}

/* SEM */
.sem-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:.5rem;}
@media(max-width:600px){.sem-grid{grid-template-columns:repeat(3,1fr);}}
.sem-cell{background:#fff;border:1px solid var(--bdr);border-radius:3px;padding:.75rem .5rem;text-align:center;}
.sem-cell.puntual{border-top:3px solid var(--sage);}
.sem-cell.tardio{border-top:3px solid var(--gold);}
.sem-cell.parcial{border-top:3px solid var(--amber);}
.sem-cell.sin_pago{border-top:3px solid var(--red);background:#fef9f9;}
.sem-mn{font-size:.6rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:rgba(24,18,10,.38);margin-bottom:.3rem;}
.sem-ic{font-size:.9rem;margin-bottom:.2rem;}
.sem-am{font-family:'Fraunces',serif;font-size:.8rem;}
.sem-dy{font-size:.58rem;color:rgba(24,18,10,.3);margin-top:.1rem;}

/* COB BAR */
.cob-row{display:flex;align-items:center;gap:1rem;margin-bottom:.4rem;}
.cob-track{flex:1;height:8px;background:rgba(24,18,10,.07);border-radius:4px;overflow:hidden;}
.cob-fill{height:100%;border-radius:4px;background:var(--sage);transition:width .5s;}
.cob-pct{font-family:'Fraunces',serif;font-size:1rem;width:48px;}

/* EBAR */
.ebar-list{display:flex;flex-direction:column;gap:.6rem;}
.ebar-row{display:flex;align-items:center;gap:.8rem;}
.ebar-lbl{font-size:.76rem;color:rgba(24,18,10,.6);width:150px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ebar-track{flex:1;height:6px;background:rgba(24,18,10,.06);border-radius:3px;overflow:hidden;}
.ebar-fill{height:100%;border-radius:3px;background:var(--gold);transition:width .4s;}
.ebar-val{font-size:.76rem;font-family:'Fraunces',serif;width:85px;text-align:right;}

/* MORA ALERT */
.mora-alert{background:linear-gradient(135deg,#fef9f0,#fdf2de);border:1px solid rgba(196,154,34,.25);
  border-left:4px solid var(--gold);border-radius:3px;padding:1rem 1.3rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:.9rem;}
.mora-alert.danger{background:#fef2f2;border-color:rgba(139,26,26,.2);border-left-color:var(--red);}
.mora-ic{font-size:1.3rem;flex-shrink:0;}
.mora-alert h3{font-family:'Fraunces',serif;font-size:.9rem;color:var(--rust);margin-bottom:.1rem;}
.mora-alert p{font-size:.76rem;color:rgba(24,18,10,.5);}

/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
@media(max-width:600px){.form-grid{grid-template-columns:1fr;}}
.form-group{display:flex;flex-direction:column;gap:.4rem;}
.form-group.full{grid-column:1/-1;}
.form-lbl{font-size:.66rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(24,18,10,.4);}
.form-input,.form-select{padding:.7rem .9rem;border:1.5px solid var(--bdr);border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.88rem;background:#fff;color:var(--ink);outline:none;transition:border-color .2s;width:100%;}
.form-input:focus,.form-select:focus{border-color:var(--gold);}
.form-hint{font-size:.68rem;color:rgba(24,18,10,.35);}
.btn-primary{padding:.75rem 1.5rem;background:var(--ink);color:var(--cream);border:none;border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:700;letter-spacing:.08em;
  text-transform:uppercase;cursor:pointer;transition:background .2s;}
.btn-primary:hover{background:var(--blue);}
.btn-primary:disabled{background:rgba(24,18,10,.3);cursor:not-allowed;}
.btn-sec{padding:.75rem 1.5rem;background:var(--cream);color:var(--ink);border:1.5px solid var(--bdr);
  border-radius:3px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-sec:hover{border-color:var(--gold);}
.form-actions{display:flex;gap:.8rem;margin-top:1.2rem;}

/* MES SELECTOR */
.mes-sel{display:flex;flex-wrap:wrap;gap:.45rem;margin-bottom:1.4rem;}
.mes-btn{padding:.38rem .85rem;border:1.5px solid var(--bdr);border-radius:2px;font-size:.7rem;
  font-weight:600;background:#fff;color:rgba(24,18,10,.5);cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;}
.mes-btn:hover{border-color:var(--gold);}
.mes-btn.active{background:var(--ink);color:var(--cream);border-color:var(--ink);}

/* ESTADO MES */
.em-toolbar{display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;}
.em-toolbar select{padding:.55rem .9rem;border:1.5px solid var(--bdr);border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.85rem;background:#fff;color:var(--ink);outline:none;}
.em-toolbar select:focus{border-color:var(--gold);}
.em-stats{display:flex;gap:1.5rem;margin-left:auto;flex-wrap:wrap;}
.em-stat{font-size:.78rem;color:rgba(24,18,10,.5);}
.em-stat strong{color:var(--ink);font-family:'Fraunces',serif;font-size:.95rem;}
.em-table-wrap{overflow-x:auto;border-radius:3px;border:1px solid var(--bdr);box-shadow:var(--sh);}
table.em-table{width:100%;border-collapse:collapse;font-size:.82rem;}
table.em-table thead th{padding:.7rem .9rem;text-align:left;font-size:.6rem;font-weight:700;
  letter-spacing:.1em;text-transform:uppercase;color:rgba(24,18,10,.38);
  background:var(--cream);border-bottom:1px solid var(--bdr);white-space:nowrap;}
table.em-table tbody tr{border-bottom:1px solid rgba(24,18,10,.04);transition:background .12s;}
table.em-table tbody tr:hover{background:rgba(24,18,10,.025);}
table.em-table tbody tr.em-ing{border-left:3px solid rgba(58,92,60,.4);}
table.em-table tbody tr.em-egr{border-left:3px solid rgba(139,26,26,.4);}
table.em-table tbody tr.em-total{background:var(--cream);font-weight:700;border-top:2px solid var(--bdr);}
table.em-table tbody td{padding:.65rem .9rem;vertical-align:middle;}
.em-ing-val{color:var(--sage);font-family:'Fraunces',serif;font-weight:500;}
.em-egr-val{color:var(--red);font-family:'Fraunces',serif;font-weight:500;}
.em-saldo{color:var(--slate);font-family:'Fraunces',serif;font-size:.8rem;}
.em-badge{display:inline-block;padding:.15rem .5rem;border-radius:2px;font-size:.6rem;
  font-weight:700;letter-spacing:.06em;text-transform:uppercase;}
.em-badge.cm{background:#f0faf2;color:var(--sage);}
.em-badge.eg{background:#fef2f2;color:var(--red);}
.em-badge.oi{background:#fef8e7;color:var(--amber);}
.em-edit-btn{background:none;border:1px solid var(--bdr);border-radius:2px;padding:.2rem .5rem;
  font-size:.65rem;color:rgba(24,18,10,.4);cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;}
.em-edit-btn:hover{border-color:var(--gold);color:var(--ink);}
.em-add-btn{display:flex;align-items:center;gap:.5rem;padding:.7rem 1.2rem;
  background:var(--ink);color:var(--cream);border:none;border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:700;letter-spacing:.08em;
  text-transform:uppercase;cursor:pointer;transition:background .2s;margin-top:1rem;}
.em-add-btn:hover{background:var(--blue);}

/* CONTRASE√ëAS */
.pwd-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-bottom:2rem;}
.pwd-card{background:#fff;border:1px solid var(--bdr);border-radius:4px;padding:1.2rem;
  box-shadow:var(--sh);display:flex;flex-direction:column;gap:.7rem;}
.pwd-card-hdr{display:flex;align-items:center;justify-content:space-between;}
.pwd-dept{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:600;color:var(--ink);}
.pwd-mora{font-size:.6rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;
  background:#fef2f2;color:var(--red);padding:.15rem .5rem;border-radius:2px;}
.pwd-field{display:flex;align-items:center;gap:.5rem;}
.pwd-input{flex:1;padding:.5rem .7rem;border:1.5px solid var(--bdr);border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.82rem;background:var(--cream);
  color:var(--ink);outline:none;transition:border-color .15s;letter-spacing:.05em;}
.pwd-input:focus{border-color:var(--gold);}
.pwd-save{padding:.5rem .8rem;background:var(--ink);color:var(--cream);border:none;
  border-radius:3px;font-family:'DM Sans',sans-serif;font-size:.72rem;font-weight:700;
  letter-spacing:.06em;text-transform:uppercase;cursor:pointer;white-space:nowrap;
  transition:background .15s;}
.pwd-save:hover{background:var(--blue);}
.pwd-save.saved{background:var(--sage);}
.pwd-toggle{background:none;border:1px solid var(--bdr);border-radius:3px;
  padding:.5rem .6rem;cursor:pointer;font-size:.8rem;color:rgba(24,18,10,.4);transition:all .15s;}
.pwd-toggle:hover{border-color:var(--gold);color:var(--ink);}
.pwd-note{font-size:.68rem;color:rgba(24,18,10,.38);margin-top:.2rem;}
.pwd-search{padding:.6rem 1rem;border:1.5px solid var(--bdr);border-radius:3px;
  font-family:'DM Sans',sans-serif;font-size:.85rem;background:#fff;outline:none;
  width:100%;max-width:300px;margin-bottom:1.5rem;transition:border-color .15s;}
.pwd-search:focus{border-color:var(--gold);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(24,18,10,.45);z-index:500;
  display:none;align-items:center;justify-content:center;padding:1rem;}
.modal-overlay.open{display:flex;}
.modal{background:#fff;border-radius:4px;padding:2rem;width:100%;max-width:540px;
  box-shadow:0 20px 60px rgba(24,18,10,.2);position:relative;max-height:90vh;overflow-y:auto;}
.modal h2{font-family:'Fraunces',serif;font-size:1.2rem;margin-bottom:1.5rem;}
.modal-close{position:absolute;top:1rem;right:1rem;background:none;border:none;
  font-size:1.2rem;cursor:pointer;color:rgba(24,18,10,.4);line-height:1;}
.modal-actions{display:flex;gap:.7rem;margin-top:1.5rem;}

/* TOAST */
.toast{position:fixed;bottom:2rem;right:2rem;background:var(--ink);color:var(--cream);
  padding:.9rem 1.4rem;border-radius:3px;font-size:.82rem;font-weight:500;
  box-shadow:0 4px 20px rgba(24,18,10,.3);z-index:9999;transform:translateY(100px);opacity:0;transition:all .3s;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.err{background:var(--red);}

.fade-in{animation:fi .3s ease-out;}
@keyframes fi{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:none;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="lcard">
    <div class="llogo">
      <div class="badge-admin">Panel de Administraci√≥n</div>
      <h1>Real de Minas 11</h1>
      <p>Acceso restringido</p>
    </div>
    <div class="fgrp"><label>Usuario</label><input id="i-user" type="text" placeholder="admin" autocomplete="off"/></div>
    <div class="fgrp"><label>Contrase√±a</label>
      <div style="position:relative;display:flex;align-items:center;">
        <input id="i-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-right:2.5rem;width:100%;"/>
        <button type="button" onclick="togglePass('i-pass','eye-admin')" style="position:absolute;right:.6rem;background:none;border:none;cursor:pointer;font-size:1.1rem;color:rgba(255,255,255,.5);padding:0;line-height:1;" id="eye-admin">üëÅ</button>
      </div>
    </div>
    <button class="lbtn" id="login-btn" onclick="doLogin()">Ingresar</button>
    <div class="lbar" id="lbar"></div>
    <div class="lerr" id="lerr">Usuario o contrase√±a incorrectos</div>
  </div>
</div>

<!-- APP -->
<div id="goodbye-screen" style="display:none;position:fixed;inset:0;background:#18120a;
  flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;z-index:100;">
  <div style="font-size:3rem">üîí</div>
  <div style="font-family:'Fraunces',serif;font-size:1.4rem;color:#f0ece4;">Sesi√≥n cerrada</div>
  <div style="font-size:.85rem;color:rgba(240,236,228,.5);">Puedes cerrar esta ventana</div>
  <button onclick="document.getElementById('goodbye-screen').style.display='none';document.getElementById('login-screen').style.display='flex';"
    style="margin-top:1rem;padding:.7rem 1.5rem;background:#c49a22;color:#18120a;
    border:none;border-radius:3px;font-family:'DM Sans',sans-serif;font-size:.82rem;
    font-weight:700;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;">
    Volver al inicio
  </button>
</div>

<div id="app">
  <nav class="topbar">
    <div class="tb-left">
      <button class="hamburger" id="hamburger" onclick="toggleSidebar()">‚ò∞</button>
      <span class="tb-badge">Admin</span>
      <span class="tb-title">Real de Minas 11</span>
    </div>
    <div class="tb-right">
      <span class="tb-sync" id="tb-sync"></span>
      <button class="lo-btn" onclick="doLogout()">Cerrar sesi√≥n</button>
    </div>
  </nav>
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <div class="app-body">
    <aside class="sidebar">
      <div class="sb-section">
        <div class="sb-lbl">General</div>
        <button class="slink active" onclick="sv('resumen',this)"><span class="ic">üìä</span>Resumen General</button>
        <button class="slink" onclick="sv('cobranza',this)"><span class="ic">üí∞</span>Cobranza</button>
        <button class="slink" onclick="sv('egresos',this)"><span class="ic">üìâ</span>Egresos</button>
      </div>
      <div class="sb-section" style="margin-top:.5rem">
        <div class="sb-lbl">Departamentos</div>
        <button class="slink" onclick="sv('depto',this)"><span class="ic">üè†</span>Por Departamento</button>
        <button class="slink" onclick="sv('morosos',this)"><span class="ic">‚ö†Ô∏è</span>Morosos</button>
      </div>
      <div class="sb-section" style="margin-top:.5rem">
        <div class="sb-lbl">Operaciones</div>
        <button class="slink" onclick="sv('estado-mes',this)"><span class="ic">üìù</span>Estado del Mes</button>
        <button class="slink" onclick="sv('contrasenas',this)"><span class="ic">üîë</span>Contrase√±as</button>
        <button class="slink" onclick="sv('nuevo-pago',this)"><span class="ic">‚ûï</span>Registrar Pago</button>
        <button class="slink" onclick="sv('nuevo-egreso',this)"><span class="ic">üìã</span>Registrar Egreso</button>
      </div>
    </aside>

    <main class="main-content">
      <div id="view-resumen" class="view active">
        <div class="content fade-in">
          <div class="page-hdr"><h1>Resumen General</h1><p id="res-sub">Cargando datos‚Ä¶</p></div>
          <div id="res-content"><div class="spin-wrap"><div class="spinner"></div><p>Leyendo Google Sheets‚Ä¶</p></div></div>
        </div>
      </div>

      <div id="view-cobranza" class="view">
        <div class="content fade-in">
          <div class="page-hdr"><h1>Cobranza</h1><p>Estado de pagos por departamento y mes</p></div>
          <div id="cob-content"><div class="spin-wrap"><div class="spinner"></div><p>Cargando‚Ä¶</p></div></div>
        </div>
      </div>

      <div id="view-egresos" class="view">
        <div class="content fade-in">
          <div class="page-hdr"><h1>Egresos</h1><p>An√°lisis de gastos por categor√≠a y mes</p></div>
          <div id="egr-content"><div class="spin-wrap"><div class="spinner"></div><p>Cargando‚Ä¶</p></div></div>
        </div>
      </div>

      <div id="view-depto" class="view">
        <div class="content fade-in">
          <div class="page-hdr"><h1>Por Departamento</h1><p>Detalle individual de cada unidad</p></div>
          <div id="dept-content"><div class="spin-wrap"><div class="spinner"></div><p>Cargando‚Ä¶</p></div></div>
        </div>
      </div>

      <div id="view-morosos" class="view">
        <div class="content fade-in">
          <div class="page-hdr"><h1>Morosos</h1><p>Departamentos con adeudos o pagos incompletos</p></div>
          <div id="mor-content"><div class="spin-wrap"><div class="spinner"></div><p>Cargando‚Ä¶</p></div></div>
        </div>
      </div>

      <div id="view-contrasenas" class="view">
        <div class="content fade-in">
          <div class="page-hdr"><h1>Contrase√±as de Cond√≥minos</h1><p>Consulta y actualiza la contrase√±a de cada departamento</p></div>
          <div id="pwd-content"></div>
        </div>
      </div>

      <div id="view-estado-mes" class="view">
        <div class="content fade-in">
          <div class="page-hdr"><h1>Estado del Mes</h1><p>Tabla completa de movimientos ‚Äî edita o agrega filas directamente</p></div>
          <div id="em-content"><div class="spin-wrap"><div class="spinner"></div><p>Cargando‚Ä¶</p></div></div>
        </div>
      </div>

      <div id="view-nuevo-pago" class="view">
        <div class="content fade-in">
          <div class="page-hdr"><h1>Registrar Pago</h1><p>Agrega un ingreso al estado de cuenta en Google Sheets</p></div>
          <div class="panel panel-pad" style="max-width:680px">
            <div class="form-grid">
              <div class="form-group"><label class="form-lbl">Departamento</label><select id="p-dept" class="form-select" onchange="updCuota()"></select></div>
              <div class="form-group"><label class="form-lbl">Mes que cubre</label><select id="p-mes" class="form-select"></select></div>
              <div class="form-group"><label class="form-lbl">Fecha del pago</label><input id="p-fecha" type="date" class="form-input"/></div>
              <div class="form-group"><label class="form-lbl">Monto</label><input id="p-monto" type="number" class="form-input" placeholder="0.00" step="0.01"/><span class="form-hint" id="p-hint"></span></div>
              <div class="form-group full"><label class="form-lbl">Concepto / Nombre</label><input id="p-conc" type="text" class="form-input" placeholder="Ej: JUAN P√âREZ DEPTO 201"/></div>
            </div>
            <div class="form-actions">
              <button class="btn-primary" id="btn-pago" onclick="guardarPago()">üíæ Guardar pago</button>
              <button class="btn-sec" onclick="limpiarPago()">Limpiar</button>
            </div>
          </div>
          <div class="panel panel-pad" style="max-width:680px">
            <p style="font-size:.78rem;color:rgba(24,18,10,.45);line-height:1.7">
              <strong>¬øC√≥mo funciona?</strong><br>
              Al guardar, el pago se agrega como una nueva fila en la hoja del mes seleccionado en Google Sheets
              con formato: <code>Fecha ¬∑ ‚Äî ¬∑ Nombre ¬∑ Ingreso ¬∑ ‚Äî ¬∑ ‚Äî ¬∑ CM-DEPTO ¬∑ ‚Äî</code><br><br>
              Los cambios se reflejan en el portal de cond√≥minos en el siguiente inicio de sesi√≥n.
            </p>
          </div>
        </div>
      </div>

      <div id="view-nuevo-egreso" class="view">
        <div class="content fade-in">
          <div class="page-hdr"><h1>Registrar Egreso</h1><p>Agrega un gasto al estado de cuenta en Google Sheets</p></div>
          <div class="panel panel-pad" style="max-width:680px">
            <div class="form-grid">
              <div class="form-group"><label class="form-lbl">Mes</label><select id="e-mes" class="form-select"></select></div>
              <div class="form-group"><label class="form-lbl">Fecha</label><input id="e-fecha" type="date" class="form-input"/></div>
              <div class="form-group"><label class="form-lbl">Categor√≠a</label><select id="e-cat" class="form-select"></select></div>
              <div class="form-group"><label class="form-lbl">Monto</label><input id="e-monto" type="number" class="form-input" placeholder="0.00" step="0.01"/></div>
              <div class="form-group full"><label class="form-lbl">Descripci√≥n / Proveedor</label><input id="e-desc" type="text" class="form-input" placeholder="Ej: Pago vigilancia enero"/></div>
            </div>
            <div class="form-actions">
              <button class="btn-primary" id="btn-egreso" onclick="guardarEgreso()">üíæ Guardar egreso</button>
              <button class="btn-sec" onclick="limpiarEgreso()">Limpiar</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- MODAL EDITAR/AGREGAR FILA -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <h2 id="modal-title">Editar movimiento</h2>
    <div class="form-grid">
      <div class="form-group"><label class="form-lbl">Fecha</label><input id="m-fecha" type="date" class="form-input"/></div>
      <div class="form-group"><label class="form-lbl">Tipo</label>
        <select id="m-tipo" class="form-select" onchange="updModalTipo()">
          <option value="ing">Ingreso</option>
          <option value="egr">Egreso</option>
        </select>
      </div>
      <div class="form-group full"><label class="form-lbl">Concepto / Descripci√≥n</label><input id="m-conc" type="text" class="form-input"/></div>
      <div class="form-group"><label class="form-lbl">Monto</label><input id="m-monto" type="number" class="form-input" step="0.01" placeholder="0.00"/></div>
      <div class="form-group" id="m-id-wrap"><label class="form-lbl" id="m-id-lbl">ID Concepto (CM-xxx)</label><input id="m-id" type="text" class="form-input" placeholder="CM-101"/></div>
    </div>
    <div class="modal-actions">
      <button class="btn-primary" id="modal-save-btn" onclick="guardarModal()">üíæ Guardar</button>
      <button class="btn-sec" onclick="closeModal()">Cancelar</button>
    </div>
    <input type="hidden" id="m-row-idx"/>
    <input type="hidden" id="m-mes"/>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SHEET_ID   = '1BmKygJycO6wTF409i0stnVg3GX26apWGgQ-byPbRlnA';
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyOdbCY0za899XC3m8AKKt3xh4bYz9-AVsWJH1idiqhsVjInkXsTLU-rZ10dnTmOJag/exec';
const GVIZ       = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

const ADMIN_USER = 'admin';
const ADMIN_PASS = 'Minas2025';

const MESES = ['Enero 2025','Febrero 2025','Marzo 2025','Abril 2025','Mayo 2025','Junio 2025','Julio 2025','Agosto 2025','Septiembre 2025','Octubre 2025','Noviembre 2025','Diciembre 2025','Enero 2026'];
const PORTAL_PASSWORDS = {"101":"bvjMeJ0s","102":"ymUmhpie","103":"Vsq1hlXy","104":"bVskvBfM","105":"78Y0YYmP","201":"QvgF7TUy","202":"TbmEchGp","204":"cWEbmYTj","205":"EbHcEOKj","301":"iJwCCKOn","302":"ljgHSta0","303":"5HVbcctK","304":"2mRc4mBE","305":"NTPhXvsz","401":"ebpi5mKi","402":"Jz66ma8Y","403":"EaDM9ecc","404":"HS07ExQv","405":"XDKBjlMz","501":"iYXZ0OTv","502":"YNl4YXzY","504":"LjYFOlxY","505":"YLV6Bybr","PH1":"RiCYmpjF","PH2":"2nfPo0OH","PH3":"Ie1J5OFi","PH4":"PQLhMCEn","PH5":"KPkwD5JU"};
const DEPTOS = ['101','102','103','104','105','201','202','204','205','301','302','303','304','305','401','402','403','404','405','501','502','504','505','PH1','PH2','PH3','PH4','PH5'];
const TOTAL_DEPTOS = 28;

const CAT = {"SM-VIG":"Vigilancia","SM-LIM":"Limpieza","SM-ADM":"Administraci√≥n","SM-BAS":"Basura","SM-JAT":"Jardiner√≠a","SM-INT":"Internet","SB-CFE":"CFE / Luz","SB-ELV":"Elevadores","SB-PLT":"Planta luz","PE-CAB":"Cable elevador","PE-INT":"Interfon","PE-CIS":"Cisterna","MR-BOM":"Bombas","MR-ELE":"Electricista","MR-VID":"Lavado vidrios","MR-GEN":"Mant. general","MR-PLOM":"Plomer√≠a","CI-INS":"Compras/insumos","ME-BAN":"Inversi√≥n/Bancos","ME-DEV":"Devoluciones","ME-CAJ":"Caja chica","ME-PEN":"Penalizaci√≥n"};
const MS  = {'Enero 2025':'Ene 25','Febrero 2025':'Feb 25','Marzo 2025':'Mar 25','Abril 2025':'Abr 25','Mayo 2025':'May 25','Junio 2025':'Jun 25','Julio 2025':'Jul 25','Agosto 2025':'Ago 25','Septiembre 2025':'Sep 25','Octubre 2025':'Oct 25','Noviembre 2025':'Nov 25','Diciembre 2025':'Dic 25','Enero 2026':'Ene 26'};
const SI  = {puntual:'‚úì',tardio:'‚úì',parcial:'~',sin_pago:'¬∑'};
const SL  = {puntual:'Puntual',tardio:'Tard√≠o',parcial:'Parcial',sin_pago:'Sin pago'};

const fmt    = n=>!n&&n!==0?'‚Äî':new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
const fmtD   = n=>new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2}).format(n);

let DATA=null, charts={}, selDept=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togglePass(inputId, btnId){
  const inp = document.getElementById(inputId);
  const btn = document.getElementById(btnId);
  if(inp.type === 'password'){ inp.type = 'text'; btn.textContent = 'üôà'; }
  else { inp.type = 'password'; btn.textContent = 'üëÅ'; }
}

function toggleSidebar(){
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('open');
}
function closeSidebar(){
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
}
function doLogin(){
  const u=(document.getElementById('i-user').value||'').trim().toLowerCase();
  const p=(document.getElementById('i-pass').value||'').trim();
  const err=document.getElementById('lerr'), btn=document.getElementById('login-btn'), bar=document.getElementById('lbar');
  const validUser=ADMIN_USER.toLowerCase();
  const validPass=ADMIN_PASS;
  document.getElementById('lerr').textContent=`u="${u}" p="${p}" ok=${u===validUser&&p===validPass}`;
  document.getElementById('lerr').style.display='block';
  if(u===validUser&&p===validPass){
    try{
      const exp = new Date(Date.now()+10*365*24*60*60*1000).toUTCString();
      document.cookie = `minas11_admin=1;expires=${exp};path=/`;
      document.cookie = `minas11_admin_pass=${encodeURIComponent(p)};expires=${exp};path=/`;
      localStorage.setItem('minas11_admin', '1');
      localStorage.setItem('minas11_admin_pass', p);
    }catch(e){}
    err.style.display='none'; btn.disabled=true; btn.textContent='Cargando datos‚Ä¶'; bar.style.display='block';
    loadAll().then(()=>{
      document.getElementById('login-screen').style.display='none';
      document.getElementById('app').style.display='flex';
      initForms(); renderAll();
    }).catch(()=>{
      btn.disabled=false; btn.textContent='Ingresar'; bar.style.display='none';
      err.textContent='Error al conectar con Google Sheets.'; err.style.display='block';
    });
  } else { err.textContent='Usuario o contrase√±a incorrectos'; err.style.display='block'; }
}
document.addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

// Auto-login if session saved
function getCookie(name){
  const m = document.cookie.match('(?:^|; )'+name+'=([^;]*)');
  return m ? decodeURIComponent(m[1]) : null;
}
(function autoLoginAdmin(){
  try{
    const saved = getCookie('minas11_admin') || localStorage.getItem('minas11_admin');
    const savedPass = getCookie('minas11_admin_pass') || localStorage.getItem('minas11_admin_pass');
    if(saved==='1' && savedPass){
      document.getElementById('i-user').value = ADMIN_USER;
      document.getElementById('i-pass').value = savedPass;
      doLogin();
    }
  }catch(e){}
})();

function doLogout(){
  try{
    document.cookie = 'minas11_admin=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/';
    document.cookie = 'minas11_admin_pass=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/';
    localStorage.removeItem('minas11_admin');
    localStorage.removeItem('minas11_admin_pass');
  }catch(e){}
  DATA=null; Object.values(charts).forEach(c=>{if(c)c.destroy();}); charts={};
  document.getElementById('app').style.display='none';
  document.getElementById('login-screen').style.display='none';
  document.getElementById('goodbye-screen').style.display='flex';
  document.getElementById('i-user').value='';
  document.getElementById('i-pass').value='';
  document.getElementById('login-btn').disabled=false;
  document.getElementById('login-btn').textContent='Ingresar';
  document.getElementById('lbar').style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sv(name,btn){
  closeSidebar();
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.slink').forEach(b=>b.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast '+(type?type+' ':'')+'show';
  setTimeout(()=>t.classList.remove('show'),3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHEETS FETCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchSheet(name){
  const res=await fetch(GVIZ+encodeURIComponent(name));
  const txt=await res.text();
  const json=JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?\s*$/)[1]);
  return json.table;
}
const rows=t=>(!t||!t.rows)?[]:t.rows.map(r=>r.c.map(c=>c?c.v:null));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOAD DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAll(){
  const results=await Promise.all(MESES.map(m=>fetchSheet(m).catch(()=>null)));

  const monthly={};
  const deptPagos={}; // {dept: [{fecha,concepto,monto,mes}]}
  const deptMontosMes={}; // {dept: {mes: total}}

  MESES.forEach((mes,idx)=>{
    const table=results[idx]; if(!table)return;
    let saldoAnt=0,totalIng=0,totalEgr=0; const ecat={},pagaron=new Set();
    rows(table).forEach((row)=>{
      if(!row[0]) return;
      if(row[0]==='SALDO MES ANTERIOR'){saldoAnt=typeof row[4]==='number'?row[4]:0;return;}
      if(row[0]==='FECHA'||row[0]==='TOTAL'||String(row[0]).includes('ESTADO DE CUENTA'))return;
      const ing=typeof row[3]==='number'?row[3]:0;
      const egr=typeof row[4]==='number'?row[4]:0;
      const nombre=row[2]||'', idC=row[6]||'', idE=row[7]||'';
      if(ing>0){
        totalIng+=ing;
        const dm=idC.match(/^CM-(.+)$/);
        if(dm){
          const dept=dm[1]; pagaron.add(dept);
          if(!deptPagos[dept])deptPagos[dept]=[];
          if(!deptMontosMes[dept])deptMontosMes[dept]={};
          deptMontosMes[dept][mes]=(deptMontosMes[dept][mes]||0)+ing;
          const f=typeof row[0]==='string'?row[0]:String(row[0]);
          // Extract day: fecha is DD/MM/YYYY
          deptPagos[dept].push({fecha:f,concepto:nombre,monto:ing,mes});
        }
      }
      if(egr>0){totalEgr+=egr; const cat=(idE||'OTROS').split('-').slice(0,2).join('-')||'OTROS'; ecat[cat]=(ecat[cat]||0)+egr;}
    });
    monthly[mes]={mes,saldo_anterior:saldoAnt,total_ingresos:totalIng,total_egresos:totalEgr,egresos_por_cat:ecat,deptos_pagaron:pagaron.size,total_deptos:TOTAL_DEPTOS,pct_cobranza:pagaron.size/TOTAL_DEPTOS};
  });

  // Calculate cuota per dept: median of non-zero monthly payments
  const deptCuota={};
  DEPTOS.forEach(dept=>{
    const montos=Object.values(deptMontosMes[dept]||{}).filter(v=>v>0);
    if(montos.length===0){deptCuota[dept]=0;return;}
    montos.sort((a,b)=>a-b);
    deptCuota[dept]=montos[Math.floor(montos.length/2)];
  });

  const deptData={};
  DEPTOS.forEach(dept=>{
    const cuota=deptCuota[dept]||0;
    const pagos=deptPagos[dept]||[];
    const resumen=MESES.map(mes=>{
      const monto=(deptMontosMes[dept]&&deptMontosMes[dept][mes])||0;
      const pm=pagos.filter(p=>p.mes===mes);
      const diaStr=pm.length>0?(pm[0].fecha||'').split('/')[0]:'';
      const dia=diaStr?parseInt(diaStr):null;
      let st='sin_pago';
      if(monto>0){st=monto>=cuota*0.98?(dia&&dia<=10?'puntual':'tardio'):'parcial';}
      return{mes,total:monto,dia,st};
    });
    // Morosidad: sum of negative differences for all months
    const morosidad=resumen.reduce((s,r)=>s+(r.total<cuota*0.98&&r.total>0?r.total-cuota:r.total===0?-cuota:0),0);
    deptData[dept]={cuota,morosidad:Math.min(morosidad,0)*-1,pagos,resumen};
  });

  DATA={monthly:MESES.map(mes=>monthly[mes]||{mes,saldo_anterior:0,total_ingresos:0,total_egresos:0,egresos_por_cat:{},deptos_pagaron:0,total_deptos:TOTAL_DEPTOS,pct_cobranza:0}),deptData};

  const t=new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('tb-sync').textContent=`Sync ${t}`;
  document.getElementById('res-sub').textContent=`${MESES.length} meses ¬∑ Actualizado ${t}`;
}

function renderAll(){rResumen();rCobranza();rEgresos();rDepto();rMorosos();rEstadoMes();rContrasenas();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESUMEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rResumen(){
  const M=DATA.monthly;
  const tIng=M.reduce((s,m)=>s+m.total_ingresos,0);
  const tEgr=M.reduce((s,m)=>s+m.total_egresos,0);
  const bal=tIng-tEgr;
  const avgCob=M.reduce((s,m)=>s+m.pct_cobranza,0)/M.length;
  const lastSaldo=M[M.length-1].saldo_anterior;
  const tMora=Object.values(DATA.deptData).reduce((s,d)=>s+d.morosidad,0);

  document.getElementById('res-content').innerHTML=`
    <div class="kpi-row c4">
      <div class="kcard g"><div class="klbl">Ingresos acumulados</div><div class="kval">${fmt(tIng)}</div><div class="ksub">${M.length} meses</div></div>
      <div class="kcard r"><div class="klbl">Egresos acumulados</div><div class="kval">${fmt(tEgr)}</div><div class="ksub">Todos los conceptos</div></div>
      <div class="kcard ${bal>=0?'g':'r'}"><div class="klbl">Balance neto</div><div class="kval">${fmt(bal)}</div><div class="ksub">Ingresos ‚àí egresos</div></div>
      <div class="kcard o"><div class="klbl">Saldo bancario</div><div class="kval">${fmt(lastSaldo)}</div><div class="ksub">√öltimo mes registrado</div></div>
    </div>
    <div class="kpi-row c2">
      <div class="kcard b"><div class="klbl">Cobranza promedio</div><div class="kval">${(avgCob*100).toFixed(1)}%</div><div class="ksub">${TOTAL_DEPTOS} departamentos</div></div>
      <div class="kcard ${tMora>0?'r':'g'}"><div class="klbl">Morosidad acumulada</div><div class="kval">${fmt(tMora)}</div><div class="ksub">${Object.values(DATA.deptData).filter(d=>d.morosidad>0).length} deptos con adeudo anterior</div></div>
    </div>
    <div class="stitle"><h2>Ingresos vs Egresos</h2><span class="tag">Por mes</span></div>
    <div class="panel panel-pad"><canvas id="ch-ie"></canvas></div>
    <div class="stitle"><h2>Saldo bancario</h2><span class="tag">Evoluci√≥n mes a mes</span></div>
    <div class="panel panel-pad"><canvas id="ch-sal"></canvas></div>
    <div class="stitle"><h2>Detalle mensual</h2><span class="tag">Selecciona un mes</span></div>
    <div class="mes-sel" id="res-msel"></div>
    <div id="res-mdet"></div>
  `;

  if(charts.ie)charts.ie.destroy();
  charts.ie=new Chart(document.getElementById('ch-ie').getContext('2d'),{type:'bar',
    data:{labels:M.map(m=>MS[m.mes]||m.mes),datasets:[
      {label:'Ingresos',data:M.map(m=>m.total_ingresos),backgroundColor:'rgba(58,92,60,.75)',borderRadius:3},
      {label:'Egresos', data:M.map(m=>m.total_egresos), backgroundColor:'rgba(139,26,26,.65)',borderRadius:3}
    ]},
    options:{responsive:true,plugins:{legend:{labels:{font:{family:'DM Sans',size:11},color:'rgba(24,18,10,.5)'}},tooltip:{callbacks:{label:c=>fmtD(c.raw)}}},
    scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'k',color:'rgba(24,18,10,.4)',font:{family:'DM Sans',size:10}},grid:{color:'rgba(24,18,10,.05)'}},
    x:{ticks:{color:'rgba(24,18,10,.45)',font:{family:'DM Sans',size:10}},grid:{display:false}}}}
  });

  if(charts.sal)charts.sal.destroy();
  charts.sal=new Chart(document.getElementById('ch-sal').getContext('2d'),{type:'line',
    data:{labels:M.map(m=>MS[m.mes]||m.mes),datasets:[{label:'Saldo bancario',
      data:M.map(m=>m.saldo_anterior),borderColor:'rgba(196,154,34,.9)',backgroundColor:'rgba(196,154,34,.08)',
      borderWidth:2,pointRadius:4,pointBackgroundColor:'rgba(196,154,34,1)',fill:true,tension:.3}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmtD(c.raw)}}},
    scales:{y:{ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'k',color:'rgba(24,18,10,.4)',font:{family:'DM Sans',size:10}},grid:{color:'rgba(24,18,10,.05)'}},
    x:{ticks:{color:'rgba(24,18,10,.45)',font:{family:'DM Sans',size:10}},grid:{display:false}}}}
  });

  const sel=document.getElementById('res-msel');
  M.forEach((m,i)=>{
    const b=document.createElement('button');
    b.className='mes-btn'+(i===0?' active':'');
    b.textContent=MS[m.mes]||m.mes;
    b.onclick=()=>{document.querySelectorAll('#res-msel .mes-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');rResMes(i);};
    sel.appendChild(b);
  });
  rResMes(0);
}

function rResMes(idx){
  const m=DATA.monthly[idx];
  const cats=Object.entries(m.egresos_por_cat).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]);
  const mx=cats.length?Math.max(...cats.map(([,v])=>v)):1;
  const cp=(m.pct_cobranza*100).toFixed(1);
  document.getElementById('res-mdet').innerHTML=`
    <div class="kpi-row c3">
      <div class="kcard g"><div class="klbl">Ingresos</div><div class="kval">${fmt(m.total_ingresos)}</div><div class="ksub">Recaudado en el mes</div></div>
      <div class="kcard r"><div class="klbl">Egresos</div><div class="kval">${fmt(m.total_egresos)}</div><div class="ksub">Pagado en el mes</div></div>
      <div class="kcard o"><div class="klbl">Saldo anterior</div><div class="kval">${fmt(m.saldo_anterior)}</div><div class="ksub">Arrastre bancario</div></div>
    </div>
    <div class="panel panel-pad">
      <div class="stitle" style="margin-top:0"><h2>Cobranza</h2></div>
      <div class="cob-row"><div class="cob-pct">${cp}%</div>
        <div class="cob-track"><div class="cob-fill" style="width:${cp}%"></div></div>
        <span style="font-size:.78rem;color:rgba(24,18,10,.5)">${m.deptos_pagaron} de ${m.total_deptos} departamentos</span>
      </div>
      <div class="stitle"><h2>Egresos por categor√≠a</h2></div>
      <div class="ebar-list">${cats.map(([cat,val])=>`
        <div class="ebar-row">
          <div class="ebar-lbl">${CAT[cat]||cat}</div>
          <div class="ebar-track"><div class="ebar-fill" style="width:${(val/mx*100).toFixed(1)}%"></div></div>
          <div class="ebar-val">${fmt(val)}</div>
        </div>`).join('')}</div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COBRANZA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rCobranza(){
  const M=DATA.monthly;
  const rows2=DEPTOS.map(dept=>{
    const d=DATA.deptData[dept];
    return{dept,cuota:d.cuota,resumen:d.resumen,morosidad:d.morosidad,total:d.pagos.reduce((s,p)=>s+p.monto,0)};
  });
  const avgCob=(M.reduce((s,m)=>s+m.pct_cobranza,0)/M.length*100).toFixed(1);

  document.getElementById('cob-content').innerHTML=`
    <div class="kpi-row c3">
      <div class="kcard g"><div class="klbl">Cobranza promedio</div><div class="kval">${avgCob}%</div><div class="ksub">Del per√≠odo completo</div></div>
      <div class="kcard b"><div class="klbl">Deptos al corriente</div><div class="kval">${rows2.filter(r=>r.morosidad===0&&r.resumen.filter(m=>m.st==='sin_pago').length<=1).length}</div><div class="ksub">Sin adeudos relevantes</div></div>
      <div class="kcard r"><div class="klbl">Deptos con problemas</div><div class="kval">${rows2.filter(r=>r.morosidad>0||r.resumen.filter(m=>m.st==='sin_pago').length>2).length}</div><div class="ksub">Requieren seguimiento</div></div>
    </div>
    <div class="stitle"><h2>Cobranza mensual</h2><span class="tag">% departamentos que pagaron</span></div>
    <div class="panel panel-pad"><canvas id="ch-cob"></canvas></div>
    <div class="stitle"><h2>Estado por departamento</h2><span class="tag">2025‚Äì2026</span></div>
    <div class="panel" style="overflow-x:auto">
      <table>
        <thead><tr><th>Depto</th><th>Cuota</th>${MESES.map(m=>`<th style="text-align:center;min-width:48px">${MS[m]||m}</th>`).join('')}<th style="text-align:right">Total pagado</th></tr></thead>
        <tbody>${rows2.map(r=>`<tr>
          <td><strong>${r.dept}</strong>${r.morosidad>0?` <span class="badge danger">mora</span>`:''}</td>
          <td class="td-muted">${fmt(r.cuota)}</td>
          ${r.resumen.map(m=>`<td style="text-align:center"><span class="badge ${m.st}">${SI[m.st]}</span></td>`).join('')}
          <td class="td-num pos">${fmt(r.total)}</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>`;

  if(charts.cob)charts.cob.destroy();
  charts.cob=new Chart(document.getElementById('ch-cob').getContext('2d'),{type:'bar',
    data:{labels:M.map(m=>MS[m.mes]||m.mes),datasets:[{label:'% Cobranza',
      data:M.map(m=>(m.pct_cobranza*100).toFixed(1)),
      backgroundColor:M.map(m=>m.pct_cobranza>=0.9?'rgba(58,92,60,.75)':m.pct_cobranza>=0.75?'rgba(196,154,34,.75)':'rgba(139,26,26,.7)'),
      borderRadius:3}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.raw+'%'}}},
    scales:{y:{min:0,max:100,ticks:{callback:v=>v+'%',color:'rgba(24,18,10,.4)',font:{family:'DM Sans',size:10}},grid:{color:'rgba(24,18,10,.05)'}},
    x:{ticks:{color:'rgba(24,18,10,.45)',font:{family:'DM Sans',size:10}},grid:{display:false}}}}
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EGRESOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rEgresos(){
  const M=DATA.monthly;
  const catTot={};
  M.forEach(m=>{Object.entries(m.egresos_por_cat).forEach(([c,v])=>{catTot[c]=(catTot[c]||0)+v;});});
  const sorted=Object.entries(catTot).sort((a,b)=>b[1]-a[1]);
  const tEgr=M.reduce((s,m)=>s+m.total_egresos,0);
  const clrs=['rgba(139,58,15,.8)','rgba(196,154,34,.8)','rgba(58,92,60,.8)','rgba(28,58,92,.8)','rgba(122,82,0,.75)','rgba(139,26,26,.75)','rgba(58,92,60,.55)','rgba(196,154,34,.55)'];

  document.getElementById('egr-content').innerHTML=`
    <div class="kpi-row c3">
      <div class="kcard r"><div class="klbl">Total egresos</div><div class="kval">${fmt(tEgr)}</div><div class="ksub">${M.length} meses</div></div>
      <div class="kcard o"><div class="klbl">Promedio mensual</div><div class="kval">${fmt(tEgr/M.length)}</div><div class="ksub">Por mes</div></div>
      <div class="kcard b"><div class="klbl">Categor√≠as activas</div><div class="kval">${sorted.length}</div><div class="ksub">Conceptos de gasto</div></div>
    </div>
    <div class="stitle"><h2>Evoluci√≥n de egresos</h2><span class="tag">Por mes</span></div>
    <div class="panel panel-pad"><canvas id="ch-egl"></canvas></div>
    <div class="stitle"><h2>Distribuci√≥n</h2><span class="tag">Per√≠odo completo</span></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem">
      <div class="panel panel-pad"><canvas id="ch-egp" style="max-height:280px"></canvas></div>
      <div class="panel panel-pad">
        <div class="ebar-list">${sorted.slice(0,10).map(([c,v])=>`
          <div class="ebar-row">
            <div class="ebar-lbl">${CAT[c]||c}</div>
            <div class="ebar-track"><div class="ebar-fill" style="width:${(v/sorted[0][1]*100).toFixed(1)}%"></div></div>
            <div class="ebar-val">${fmt(v)}</div>
          </div>`).join('')}
        </div>
      </div>
    </div>
    <div class="stitle"><h2>Desglose mensual</h2><span class="tag">Tabla completa</span></div>
    <div class="panel" style="overflow-x:auto">
      <table>
        <thead><tr><th>Categor√≠a</th>${M.map(m=>`<th style="text-align:right">${MS[m.mes]||m.mes}</th>`).join('')}<th style="text-align:right">Total</th></tr></thead>
        <tbody>
          ${sorted.map(([c,total])=>`<tr>
            <td><strong>${CAT[c]||c}</strong></td>
            ${M.map(m=>`<td class="td-num ${(m.egresos_por_cat[c]||0)>0?'neg':''}">${m.egresos_por_cat[c]?fmt(m.egresos_por_cat[c]):'‚Äî'}</td>`).join('')}
            <td class="td-num neg"><strong>${fmt(total)}</strong></td>
          </tr>`).join('')}
          <tr style="background:var(--cream)">
            <td><strong>TOTAL</strong></td>
            ${M.map(m=>`<td class="td-num neg"><strong>${fmt(m.total_egresos)}</strong></td>`).join('')}
            <td class="td-num neg"><strong>${fmt(tEgr)}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>`;

  if(charts.egl)charts.egl.destroy();
  const top=sorted.slice(0,4).map(([c])=>c);
  charts.egl=new Chart(document.getElementById('ch-egl').getContext('2d'),{type:'line',
    data:{labels:M.map(m=>MS[m.mes]||m.mes),datasets:[
      {label:'Total egresos',data:M.map(m=>m.total_egresos),borderColor:'rgba(139,26,26,.8)',backgroundColor:'rgba(139,26,26,.07)',borderWidth:2.5,pointRadius:3,fill:true,tension:.3},
      ...top.map((c,i)=>({label:CAT[c]||c,data:M.map(m=>m.egresos_por_cat[c]||0),borderColor:clrs[i+1],borderWidth:1.5,pointRadius:2,fill:false,tension:.3,borderDash:i>0?[4,3]:[]}))
    ]},
    options:{responsive:true,plugins:{legend:{labels:{font:{family:'DM Sans',size:10},color:'rgba(24,18,10,.5)'}},tooltip:{callbacks:{label:c=>fmtD(c.raw)}}},
    scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'k',color:'rgba(24,18,10,.4)',font:{family:'DM Sans',size:10}},grid:{color:'rgba(24,18,10,.05)'}},
    x:{ticks:{color:'rgba(24,18,10,.45)',font:{family:'DM Sans',size:10}},grid:{display:false}}}}
  });

  if(charts.egp)charts.egp.destroy();
  charts.egp=new Chart(document.getElementById('ch-egp').getContext('2d'),{type:'doughnut',
    data:{labels:sorted.slice(0,8).map(([c])=>CAT[c]||c),datasets:[{data:sorted.slice(0,8).map(([,v])=>v),backgroundColor:clrs,borderWidth:2,borderColor:'#fff'}]},
    options:{responsive:true,plugins:{legend:{position:'right',labels:{font:{family:'DM Sans',size:10},color:'rgba(24,18,10,.6)',boxWidth:12}},tooltip:{callbacks:{label:c=>` ${c.label}: ${fmt(c.raw)}`}}}}
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEPTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rDepto(){
  const first=selDept||DEPTOS[0];
  document.getElementById('dept-content').innerHTML=`
    <div class="stitle" style="margin-top:0"><h2>Selecciona un departamento</h2></div>
    <div class="dept-grid" id="dg">${DEPTOS.map(d=>`<button class="dept-btn ${DATA.deptData[d].morosidad>0?'mora':''} ${d===first?'active':''}" onclick="selDepto('${d}',this)">${d}</button>`).join('')}</div>
    <div id="dd"></div>`;
  rDeptDetail(first);
}

function selDepto(dept,btn){
  selDept=dept;
  document.querySelectorAll('.dept-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  rDeptDetail(dept);
}

function rDeptDetail(dept){
  const d=DATA.deptData[dept];
  const resumen=d.resumen;
  const tPag=d.pagos.reduce((s,p)=>s+p.monto,0);
  const esp=d.cuota*resumen.length;
  const pct=esp>0?(tPag/esp*100).toFixed(1):0;
  const nP=resumen.filter(m=>m.st==='puntual').length;
  const nT=resumen.filter(m=>m.st==='tardio').length;
  const nPa=resumen.filter(m=>m.st==='parcial').length;
  const nS=resumen.filter(m=>m.st==='sin_pago').length;

  let html='';
  if(d.morosidad>0)html+=`<div class="mora-alert danger"><div class="mora-ic">üö®</div><div><h3>Adeudo anterior: ${fmtD(d.morosidad)}</h3><p>Saldo pendiente de a√±os anteriores. Requiere convenio de pago.</p></div></div>`;

  html+=`
    <div class="kpi-row c4">
      <div class="kcard g"><div class="klbl">Total pagado</div><div class="kval">${fmt(tPag)}</div><div class="ksub">${d.pagos.length} transacciones</div></div>
      <div class="kcard o"><div class="klbl">Cuota mensual</div><div class="kval">${fmt(d.cuota)}</div><div class="ksub">Vigente</div></div>
      <div class="kcard ${pct>=90?'g':pct>=60?'o':'r'}"><div class="klbl">Cumplimiento</div><div class="kval">${pct}%</div><div class="ksub">Sobre esperado</div></div>
      <div class="kcard s"><div class="klbl">Meses sin pago</div><div class="kval">${nS}</div><div class="ksub">${nP} puntual ¬∑ ${nT} tard√≠o ¬∑ ${nPa} parcial</div></div>
    </div>
    <div class="stitle"><h2>Evoluci√≥n de pagos</h2><span class="tag">vs cuota esperada</span></div>
    <div class="panel panel-pad"><canvas id="ch-dept"></canvas></div>
    <div class="stitle"><h2>Sem√°foro mensual</h2><span class="tag">${resumen.length} meses</span></div>
    <div class="panel panel-pad"><div class="sem-grid">${resumen.map(m=>`
      <div class="sem-cell ${m.st}">
        <div class="sem-mn">${MS[m.mes]||m.mes}</div>
        <div class="sem-ic">${SI[m.st]}</div>
        <div class="sem-am">${m.total>0?fmt(m.total):'‚Äî'}</div>
        <div class="sem-dy">${m.dia?'D√≠a '+m.dia:SL[m.st]}</div>
      </div>`).join('')}</div></div>
    <div class="stitle"><h2>Movimientos</h2><span class="tag">${d.pagos.length} registros</span></div>
    <div class="panel"><table>
      <thead><tr><th>Fecha</th><th>Concepto</th><th>Mes</th><th style="text-align:right">Monto</th><th>Estado</th></tr></thead>
      <tbody>${[...d.pagos].sort((a,b)=>b.fecha.split('/').reverse().join('').localeCompare(a.fecha.split('/').reverse().join(''))).map(p=>{
        const ms=resumen.find(m=>m.mes===p.mes);
        const st=ms?ms.st:'parcial';
        return`<tr><td class="td-muted">${p.fecha}</td><td>${p.concepto}</td><td class="td-muted">${p.mes}</td><td class="td-num pos">${fmtD(p.monto)}</td><td><span class="badge ${st}">${SL[st]}</span></td></tr>`;
      }).join('')}</tbody>
    </table></div>`;

  document.getElementById('dd').innerHTML=html;
  if(charts.dept)charts.dept.destroy();
  const bc=resumen.map(m=>m.st==='puntual'?'rgba(58,92,60,.8)':m.st==='tardio'?'rgba(196,154,34,.8)':m.st==='parcial'?'rgba(122,82,0,.7)':'rgba(139,26,26,.75)');
  charts.dept=new Chart(document.getElementById('ch-dept').getContext('2d'),{type:'bar',
    data:{labels:resumen.map(m=>MS[m.mes]||m.mes),datasets:[
      {label:'Pago realizado',data:resumen.map(m=>m.total),backgroundColor:bc,borderRadius:3},
      {label:'Cuota',data:resumen.map(()=>d.cuota),type:'line',borderColor:'rgba(24,18,10,.2)',borderDash:[4,3],borderWidth:1.5,pointRadius:0,fill:false,tension:0}
    ]},
    options:{responsive:true,plugins:{legend:{labels:{font:{family:'DM Sans',size:11},color:'rgba(24,18,10,.5)'}},tooltip:{callbacks:{label:c=>fmtD(c.raw)}}},
    scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+(v/1000).toFixed(0)+'k',color:'rgba(24,18,10,.4)',font:{family:'DM Sans',size:10}},grid:{color:'rgba(24,18,10,.05)'}},
    x:{ticks:{color:'rgba(24,18,10,.45)',font:{family:'DM Sans',size:10}},grid:{display:false}}}}
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOROSOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rMorosos(){
  const rows2=DEPTOS.map(dept=>{
    const d=DATA.deptData[dept];
    const nS=d.resumen.filter(m=>m.st==='sin_pago').length;
    const nPa=d.resumen.filter(m=>m.st==='parcial').length;
    const tPag=d.pagos.reduce((s,p)=>s+p.monto,0);
    const esp=d.cuota*d.resumen.length;
    return{dept,cuota:d.cuota,morosidad:d.morosidad,nS,nPa,diff:tPag-esp,tPag,esp};
  }).filter(r=>r.morosidad>0||r.nS>1||r.diff<-r.cuota);

  const tMora=rows2.reduce((s,r)=>s+r.morosidad,0);
  const tDiff=rows2.reduce((s,r)=>s+(r.diff<0?r.diff:0),0);

  document.getElementById('mor-content').innerHTML=`
    <div class="kpi-row c3">
      <div class="kcard r"><div class="klbl">Deptos irregulares</div><div class="kval">${rows2.length}</div><div class="ksub">Requieren seguimiento</div></div>
      <div class="kcard r"><div class="klbl">Morosidad anterior</div><div class="kval">${fmt(tMora)}</div><div class="ksub">Adeudos de a√±os previos</div></div>
      <div class="kcard o"><div class="klbl">Diferencia acumulada</div><div class="kval">${fmt(Math.abs(tDiff))}</div><div class="ksub">Por debajo de lo esperado</div></div>
    </div>
    <div class="stitle"><h2>Departamentos con adeudos</h2><span class="tag">${rows2.length} unidades</span></div>
    <div class="panel"><table>
      <thead><tr><th>Depto</th><th style="text-align:right">Cuota</th><th style="text-align:right">Mora anterior</th>
        <th style="text-align:center">Sin pago</th><th style="text-align:center">Parciales</th>
        <th style="text-align:right">Total pagado</th><th style="text-align:right">Esperado</th>
        <th style="text-align:right">Diferencia</th><th>Situaci√≥n</th></tr></thead>
      <tbody>${rows2.sort((a,b)=>a.diff-b.diff).map(r=>{
        const lv=r.morosidad>0||r.nS>3?'danger':r.nS>1||r.diff<-r.cuota*2?'warn':'ok';
        const lb=lv==='danger'?'Cr√≠tico':lv==='warn'?'Atenci√≥n':'Leve';
        return`<tr>
          <td><strong>${r.dept}</strong></td>
          <td class="td-num">${fmt(r.cuota)}</td>
          <td class="td-num ${r.morosidad>0?'neg':''}">${r.morosidad>0?fmt(r.morosidad):'‚Äî'}</td>
          <td style="text-align:center"><strong style="color:var(--red)">${r.nS}</strong></td>
          <td style="text-align:center"><strong style="color:var(--amber)">${r.nPa}</strong></td>
          <td class="td-num pos">${fmt(r.tPag)}</td>
          <td class="td-num">${fmt(r.esp)}</td>
          <td class="td-num ${r.diff<0?'neg':'pos'}">${fmt(r.diff)}</td>
          <td><span class="badge ${lv}">${lb}</span></td>
        </tr>`;
      }).join('')}</tbody>
    </table></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initForms(){
  document.getElementById('p-dept').innerHTML=DEPTOS.map(d=>`<option value="${d}">${d}</option>`).join('');
  document.getElementById('p-mes').innerHTML=MESES.map(m=>`<option value="${m}">${m}</option>`).join('');
  document.getElementById('p-mes').value=MESES[MESES.length-1];
  document.getElementById('e-mes').innerHTML=MESES.map(m=>`<option value="${m}">${m}</option>`).join('');
  document.getElementById('e-mes').value=MESES[MESES.length-1];
  document.getElementById('e-cat').innerHTML=Object.entries(CAT).map(([k,v])=>`<option value="${k}">${v}</option>`).join('');
  const hoy=new Date().toISOString().split('T')[0];
  document.getElementById('p-fecha').value=hoy;
  document.getElementById('e-fecha').value=hoy;
  updCuota();
}

function updCuota(){
  const dept=document.getElementById('p-dept').value;
  const d=DATA?.deptData[dept];
  if(d){
    document.getElementById('p-hint').textContent=`Cuota mensual: ${fmtD(d.cuota)}`;
    document.getElementById('p-monto').value=d.cuota.toFixed(2);
    document.getElementById('p-conc').value=`DEPTO ${dept}`;
  }
}

async function guardarPago(){
  const dept=document.getElementById('p-dept').value;
  const mes=document.getElementById('p-mes').value;
  const fecha=document.getElementById('p-fecha').value;
  const monto=parseFloat(document.getElementById('p-monto').value);
  const conc=document.getElementById('p-conc').value.trim();
  if(!fecha||!monto||!conc){toast('Completa todos los campos','err');return;}
  const[y,m,d]=fecha.split('-');
  const btn=document.getElementById('btn-pago');
  btn.disabled=true; btn.textContent='Guardando‚Ä¶';
  try{
    const res=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({hoja:mes,fila:[`${d}/${m}/${y}`,null,conc,monto,null,null,`CM-${dept}`,null]})});
    const data=await res.json();
    if(data.ok){toast(`‚úì Pago de Depto ${dept} guardado en ${mes}`);limpiarPago();}
    else{toast('Error: '+data.error,'err');}
  }catch(e){toast('Error de conexi√≥n','err');}
  finally{btn.disabled=false;btn.textContent='üíæ Guardar pago';}
}

async function guardarEgreso(){
  const mes=document.getElementById('e-mes').value;
  const fecha=document.getElementById('e-fecha').value;
  const cat=document.getElementById('e-cat').value;
  const monto=parseFloat(document.getElementById('e-monto').value);
  const desc=document.getElementById('e-desc').value.trim();
  if(!fecha||!monto||!desc){toast('Completa todos los campos','err');return;}
  const[y,m,d]=fecha.split('-');
  const btn=document.getElementById('btn-egreso');
  btn.disabled=true; btn.textContent='Guardando‚Ä¶';
  try{
    const res=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({hoja:mes,fila:[`${d}/${m}/${y}`,null,desc,null,monto,null,null,cat]})});
    const data=await res.json();
    if(data.ok){toast(`‚úì Egreso guardado en ${mes}`);limpiarEgreso();}
    else{toast('Error: '+data.error,'err');}
  }catch(e){toast('Error de conexi√≥n','err');}
  finally{btn.disabled=false;btn.textContent='üíæ Guardar egreso';}
}

function limpiarPago(){document.getElementById('p-monto').value='';document.getElementById('p-conc').value='';updCuota();}
function limpiarEgreso(){document.getElementById('e-monto').value='';document.getElementById('e-desc').value='';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONTRASE√ëAS (desde Google Sheets)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pwdCache = {};

async function loadPwds(){
  try{
    const table = await fetchSheet('Contrase√±as');
    const r = rows(table);
    const pwds = {};
    r.forEach(row => {
      if(row[0] && row[1]) pwds[String(row[0])] = String(row[1]);
    });
    pwdCache = pwds;
    return pwds;
  }catch(e){
    console.error('Error loading passwords:', e);
    return {};
  }
}

async function rContrasenas(){
  const container = document.getElementById('pwd-content');
  container.innerHTML = '<div class="spin-wrap"><div class="spinner"></div><p>Cargando contrase√±as‚Ä¶</p></div>';
  const pwds = await loadPwds();
  const deptData = DATA ? DATA.deptData : {};

  container.innerHTML = `
    <input class="pwd-search" type="text" placeholder="Buscar departamento‚Ä¶" oninput="filterPwds(this.value)"/>
    <div class="pwd-grid" id="pwd-grid">
      ${DEPTOS.map(dept => {
        const pwd = pwds[dept] || '';
        const mora = deptData[dept] && deptData[dept].morosidad > 0;
        return `<div class="pwd-card" data-dept="${dept}">
          <div class="pwd-card-hdr">
            <span class="pwd-dept">Depto ${dept}</span>
            ${mora ? '<span class="pwd-mora">Mora</span>' : ''}
          </div>
          <div class="pwd-field">
            <input class="pwd-input" id="pwd-inp-${dept}" type="password" value="${pwd}" autocomplete="off"/>
            <button class="pwd-toggle" onclick="togglePwdVis('${dept}')" title="Mostrar/ocultar">üëÅ</button>
            <button class="pwd-save" id="pwd-btn-${dept}" onclick="guardarPwd('${dept}')">Guardar</button>
          </div>
          <div class="pwd-note">Usuario: ${dept}</div>
        </div>`;
      }).join('')}
    </div>
  `;
}

function filterPwds(q){
  document.querySelectorAll('#pwd-grid .pwd-card').forEach(card => {
    card.style.display = card.dataset.dept.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
  });
}

function togglePwdVis(dept){
  const inp = document.getElementById('pwd-inp-' + dept);
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

async function guardarPwd(dept){
  const inp = document.getElementById('pwd-inp-' + dept);
  const pwd = inp.value.trim();
  if(!pwd){ toast('La contrase√±a no puede estar vac√≠a', 'err'); return; }
  const btn = document.getElementById('pwd-btn-' + dept);
  btn.disabled = true; btn.textContent = 'Guardando‚Ä¶';
  try{
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({accion: 'pwd', hoja: 'Contrase√±as', dept, pwd})
    });
    const data = await res.json();
    if(data.ok){
      toast(`‚úì Contrase√±a de ${dept} actualizada`);
      btn.textContent = '‚úì Guardado'; btn.classList.add('saved');
      setTimeout(() => { btn.textContent = 'Guardar'; btn.classList.remove('saved'); }, 2000);
    } else { toast('Error: ' + (data.error || 'desconocido'), 'err'); }
  }catch(e){ toast('Error de conexi√≥n', 'err'); }
  finally{ btn.disabled = false; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ESTADO DEL MES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let emRawRows={}; // cache raw rows per mes

async function rEstadoMes(){
  const container=document.getElementById('em-content');
  // Build toolbar with mes selector
  container.innerHTML=`
    <div class="em-toolbar">
      <select id="em-sel" onchange="loadEstadoMes(this.value)">
        ${MESES.map(m=>`<option value="${m}">${m}</option>`).join('')}
      </select>
      <div class="em-stats" id="em-stats"></div>
    </div>
    <div id="em-table-wrap"><div class="spin-wrap"><div class="spinner"></div><p>Cargando‚Ä¶</p></div></div>
    <button class="em-add-btn" onclick="openModal(null)">Ôºã Agregar movimiento</button>
  `;
  // Load last month by default
  const defaultMes=MESES[MESES.length-1];
  document.getElementById('em-sel').value=defaultMes;
  await loadEstadoMes(defaultMes);
}

async function loadEstadoMes(mes){
  document.getElementById('em-table-wrap').innerHTML='<div class="spin-wrap"><div class="spinner"></div><p>Cargando‚Ä¶</p></div>';
  try{
    const table=await fetchSheet(mes);
    const rawRows=rows(table);
    emRawRows[mes]=rawRows;
    renderEstadoMesTable(mes,rawRows);
  }catch(e){
    document.getElementById('em-table-wrap').innerHTML=`<p style="padding:1rem;color:var(--red)">Error cargando ${mes}</p>`;
  }
}

function renderEstadoMesTable(mes,rawRows){
  let saldo=0,tIng=0,tEgr=0;
  const dataRows=[];

  rawRows.forEach((row,i)=>{
    if(!row[0])return;
    if(row[0]==='SALDO MES ANTERIOR'){saldo=typeof row[4]==='number'?row[4]:0;return;}
    if(row[0]==='FECHA'||String(row[0]).includes('ESTADO DE CUENTA'))return;
    const isTotal=row[0]==='TOTAL';
    const ing=typeof row[3]==='number'?row[3]:0;
    const egr=typeof row[4]==='number'?row[4]:0;
    const sal=typeof row[5]==='number'?row[5]:null;
    const idC=row[6]||'';
    const idE=row[7]||'';
    if(!isTotal){tIng+=ing;tEgr+=egr;}
    dataRows.push({i,fecha:row[0],id:row[1]||'',concepto:row[2]||'',ing,egr,saldo:sal,idC,idE,isTotal});
  });

  // Update stats
  document.getElementById('em-stats').innerHTML=`
    <div class="em-stat">Saldo anterior <strong>${fmt(saldo)}</strong></div>
    <div class="em-stat">Ingresos <strong style="color:var(--sage)">${fmt(tIng)}</strong></div>
    <div class="em-stat">Egresos <strong style="color:var(--red)">${fmt(tEgr)}</strong></div>
    <div class="em-stat">Balance <strong style="color:${tIng-tEgr>=0?'var(--sage)':'var(--red)'}">${fmt(tIng-tEgr)}</strong></div>
  `;

  const rows2=dataRows.map(r=>{
    if(r.isTotal) return`<tr class="em-total">
      <td colspan="3"><strong>TOTAL</strong></td>
      <td class="em-ing-val" style="text-align:right">${r.ing>0?fmt(r.ing):''}</td>
      <td class="em-egr-val" style="text-align:right">${r.egr>0?fmt(r.egr):''}</td>
      <td class="em-saldo" style="text-align:right">${r.saldo!=null?fmt(r.saldo):''}</td>
      <td colspan="3"></td>
    </tr>`;
    const tipo=r.ing>0?'ing':r.egr>0?'egr':'';
    const badgeId=r.idC||r.idE;
    const badgeType=r.idC?'cm':r.idE?'eg':'oi';
    return`<tr class="em-${tipo||''}">
      <td class="td-muted" style="white-space:nowrap">${r.fecha}</td>
      <td class="td-muted">${r.id}</td>
      <td>${r.concepto}</td>
      <td class="em-ing-val" style="text-align:right">${r.ing>0?fmtD(r.ing):''}</td>
      <td class="em-egr-val" style="text-align:right">${r.egr>0?fmtD(r.egr):''}</td>
      <td class="em-saldo" style="text-align:right">${r.saldo!=null?fmt(r.saldo):''}</td>
      <td>${badgeId?`<span class="em-badge ${badgeType}">${badgeId}</span>`:''}</td>
      <td>${CAT[badgeId]||''}</td>
      <td><button class="em-edit-btn" onclick="openModal(${r.i},'${mes}')">‚úèÔ∏è Editar</button></td>
    </tr>`;
  }).join('');

  document.getElementById('em-table-wrap').innerHTML=`
    <div class="em-table-wrap">
      <table class="em-table">
        <thead><tr>
          <th>Fecha</th><th>ID</th><th>Concepto</th>
          <th style="text-align:right">Ingreso</th><th style="text-align:right">Egreso</th>
          <th style="text-align:right">Saldo</th><th>ID Cat.</th><th>Categor√≠a</th><th></th>
        </tr></thead>
        <tbody>${rows2}</tbody>
      </table>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(rowIdx, mes){
  const overlay=document.getElementById('modal-overlay');
  const hoy=new Date().toISOString().split('T')[0];
  document.getElementById('m-mes').value=mes||document.getElementById('em-sel').value;
  document.getElementById('m-row-idx').value=rowIdx!=null?rowIdx:'';

  if(rowIdx!=null&&mes){
    // Edit existing row
    document.getElementById('modal-title').textContent='Editar movimiento';
    const row=emRawRows[mes]&&emRawRows[mes][rowIdx];
    if(row){
      // fecha DD/MM/YYYY ‚Üí YYYY-MM-DD for input
      const parts=(row[0]||'').split('/');
      const fechaInput=parts.length===3?`${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`:hoy;
      document.getElementById('m-fecha').value=fechaInput;
      const isEgr=typeof row[4]==='number'&&row[4]>0;
      document.getElementById('m-tipo').value=isEgr?'egr':'ing';
      document.getElementById('m-conc').value=row[2]||'';
      document.getElementById('m-monto').value=isEgr?row[4]:(row[3]||'');
      document.getElementById('m-id').value=isEgr?(row[7]||''):(row[6]||'');
      updModalTipo();
    }
  } else {
    // New row
    document.getElementById('modal-title').textContent='Agregar movimiento';
    document.getElementById('m-fecha').value=hoy;
    document.getElementById('m-tipo').value='ing';
    document.getElementById('m-conc').value='';
    document.getElementById('m-monto').value='';
    document.getElementById('m-id').value='';
    updModalTipo();
  }
  overlay.classList.add('open');
}

function closeModal(e){
  if(e&&e.target!==document.getElementById('modal-overlay'))return;
  document.getElementById('modal-overlay').classList.remove('open');
}

function updModalTipo(){
  const tipo=document.getElementById('m-tipo').value;
  document.getElementById('m-id-lbl').textContent=tipo==='ing'?'ID Concepto (CM-xxx)':'ID Egreso (SM-VIG, SB-CFE‚Ä¶)';
  document.getElementById('m-id').placeholder=tipo==='ing'?'CM-101':'SM-VIG';
}

async function guardarModal(){
  const mes=document.getElementById('m-mes').value;
  const rowIdx=document.getElementById('m-row-idx').value;
  const fechaRaw=document.getElementById('m-fecha').value; // YYYY-MM-DD
  const tipo=document.getElementById('m-tipo').value;
  const conc=document.getElementById('m-conc').value.trim();
  const monto=parseFloat(document.getElementById('m-monto').value);
  const id=document.getElementById('m-id').value.trim().toUpperCase();

  if(!fechaRaw||!conc||!monto){toast('Completa todos los campos','err');return;}

  const[y,m,d]=fechaRaw.split('-');
  const fecha=`${d}/${m}/${y}`;
  const fila=tipo==='ing'
    ?[fecha,null,conc,monto,null,null,id||null,null]
    :[fecha,null,conc,null,monto,null,null,id||null];

  const btn=document.getElementById('modal-save-btn');
  btn.disabled=true; btn.textContent='Guardando‚Ä¶';

  try{
    const body=rowIdx!==''
      ?{hoja:mes,fila,rowIdx:parseInt(rowIdx),accion:'editar'}
      :{hoja:mes,fila};
    const res=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(body)});
    const data=await res.json();
    if(data.ok){
      toast(`‚úì Guardado en ${mes}`);
      document.getElementById('modal-overlay').classList.remove('open');
      await loadEstadoMes(mes);
    } else {toast('Error: '+(data.error||'desconocido'),'err');}
  }catch(e){toast('Error de conexi√≥n','err');}
  finally{btn.disabled=false;btn.textContent='üíæ Guardar';}
}
</script>
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
